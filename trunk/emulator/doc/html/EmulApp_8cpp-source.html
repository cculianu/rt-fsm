<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<html><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8">
<title>FSMEmulator: EmulApp.cpp Source File</title>
<link href="doxygen.css" rel="stylesheet" type="text/css">
<link href="tabs.css" rel="stylesheet" type="text/css">
</head><body>
<!-- Generated by Doxygen 1.5.4 -->
<div class="tabs">
  <ul>
    <li><a href="index.html"><span>Main&nbsp;Page</span></a></li>
    <li><a href="annotated.html"><span>Classes</span></a></li>
    <li class="current"><a href="files.html"><span>Files</span></a></li>
  </ul>
</div>
<h1>EmulApp.cpp</h1><div class="fragment"><pre class="fragment"><a name="l00001"></a>00001 <span class="preprocessor">#if defined(Q_OS_WIN) || defined(Q_OS_CYGWIN) || defined(WIN32)</span>
<a name="l00002"></a>00002 <span class="preprocessor"></span><span class="preprocessor">#  define _WIN32_WINNT 0x0501</span>
<a name="l00003"></a>00003 <span class="preprocessor"></span><span class="preprocessor">#  define WIN32_LEAN_AND_MEAN</span>
<a name="l00004"></a>00004 <span class="preprocessor"></span><span class="preprocessor">#  include &lt;windows.h&gt;</span>
<a name="l00005"></a>00005 <span class="preprocessor">#  include &lt;psapi.h&gt;</span>
<a name="l00006"></a>00006 <span class="preprocessor">#else</span>
<a name="l00007"></a>00007 <span class="preprocessor"></span><span class="preprocessor">#  include &lt;unistd.h&gt;</span>
<a name="l00008"></a>00008 <span class="preprocessor">#endif</span>
<a name="l00009"></a>00009 <span class="preprocessor"></span><span class="preprocessor">#include &lt;QTextEdit&gt;</span>
<a name="l00010"></a>00010 <span class="preprocessor">#include &lt;QMessageBox&gt;</span>
<a name="l00011"></a>00011 <span class="preprocessor">#include "EmulApp.h"</span>
<a name="l00012"></a>00012 <span class="preprocessor">#include "MainWindow.h"</span>
<a name="l00013"></a>00013 <span class="preprocessor">#include "Log.h"</span>
<a name="l00014"></a>00014 <span class="preprocessor">#include "Version.h"</span>
<a name="l00015"></a>00015 <span class="preprocessor">#include "Common.h"</span>
<a name="l00016"></a>00016 <span class="preprocessor">#include &lt;qglobal.h&gt;</span>
<a name="l00017"></a>00017 <span class="preprocessor">#include &lt;QEvent&gt;</span>
<a name="l00018"></a>00018 <span class="preprocessor">#include &lt;cstdlib&gt;</span>
<a name="l00019"></a>00019 <span class="preprocessor">#include &lt;QSettings&gt;</span>
<a name="l00020"></a>00020 <span class="preprocessor">#include &lt;QMetaType&gt;</span>
<a name="l00021"></a>00021 <span class="preprocessor">#include &lt;QStatusBar&gt;</span>
<a name="l00022"></a>00022 <span class="preprocessor">#include &lt;QTimer&gt;</span>
<a name="l00023"></a>00023 <span class="preprocessor">#include &lt;QKeyEvent&gt;</span>
<a name="l00024"></a>00024 <span class="preprocessor">#include &lt;QFileDialog&gt;</span>
<a name="l00025"></a>00025 <span class="preprocessor">#include &lt;QTextStream&gt;</span>
<a name="l00026"></a>00026 <span class="preprocessor">#include &lt;QFile&gt;</span>
<a name="l00027"></a>00027 <span class="preprocessor">#include &lt;QFileInfo&gt;</span>
<a name="l00028"></a>00028 <span class="preprocessor">#include &lt;QPixmap&gt;</span>
<a name="l00029"></a>00029 <span class="preprocessor">#include &lt;QIcon&gt;</span>
<a name="l00030"></a>00030 <span class="preprocessor">#include &lt;QRadialGradient&gt;</span>
<a name="l00031"></a>00031 <span class="preprocessor">#include &lt;QPainter&gt;</span>
<a name="l00032"></a>00032 <span class="preprocessor">#include &lt;QDir&gt;</span>
<a name="l00033"></a>00033 <span class="preprocessor">#include &lt;QDesktopWidget&gt;</span>
<a name="l00034"></a>00034 <span class="preprocessor">#include &lt;QMutexLocker&gt;</span>
<a name="l00035"></a>00035 <span class="preprocessor">#include &lt;sstream&gt;</span>
<a name="l00036"></a>00036 <span class="preprocessor">#include &lt;QCloseEvent&gt;</span>
<a name="l00037"></a>00037 <span class="preprocessor">#include "kernel_emul.h"</span>
<a name="l00038"></a>00038 <span class="preprocessor">#include "ProcFileViewer.h"</span>
<a name="l00039"></a>00039 <span class="preprocessor">#include "ModuleParmView.h"</span>
<a name="l00040"></a>00040 <span class="preprocessor">#include &lt;QPushButton&gt;</span>
<a name="l00041"></a>00041 <span class="preprocessor">#include &lt;QGridLayout&gt;</span>
<a name="l00042"></a>00042 <span class="preprocessor">#include &lt;QScrollArea&gt;</span>
<a name="l00043"></a>00043 <span class="preprocessor">#include &lt;QLabel&gt;</span>
<a name="l00044"></a>00044 <span class="preprocessor">#include &lt;QList&gt;</span>
<a name="l00045"></a>00045 <span class="preprocessor">#include &lt;QGroupBox&gt;</span>
<a name="l00046"></a>00046 <span class="preprocessor">#include "ControlWin.h"</span>
<a name="l00047"></a>00047 <span class="preprocessor">#include &lt;QStringList&gt;</span>
<a name="l00048"></a>00048 <span class="preprocessor">#include &lt;QRegExp&gt;</span>
<a name="l00049"></a>00049 <span class="preprocessor">#include &lt;QFile&gt;</span>
<a name="l00050"></a>00050 <span class="preprocessor">#include "FSMExternalTrig.h"</span>
<a name="l00051"></a>00051 <span class="preprocessor">#include "rtos_utility.h"</span>
<a name="l00052"></a>00052 <span class="preprocessor">#include &lt;QProcess&gt;</span>
<a name="l00053"></a>00053 <span class="preprocessor">#if defined(OS_LINUX) || defined(OS_OSX)</span>
<a name="l00054"></a>00054 <span class="preprocessor"></span><span class="preprocessor">#include "scanproc.h"</span>
<a name="l00055"></a>00055 <span class="preprocessor">#endif</span>
<a name="l00056"></a>00056 <span class="preprocessor"></span><span class="preprocessor">#include "SoundTrig.h"</span>
<a name="l00057"></a>00057 <span class="preprocessor">#include &lt;QThread&gt;</span>
<a name="l00058"></a>00058 <span class="preprocessor">#include &lt;QMutex&gt;</span>
<a name="l00059"></a>00059 <span class="preprocessor">#include &lt;QWaitCondition&gt;</span>
<a name="l00060"></a>00060 <span class="preprocessor">#include "SoundPlayer.h"</span>
<a name="l00061"></a>00061 <span class="preprocessor">#include &lt;QMenuBar&gt;</span>
<a name="l00062"></a>00062 <span class="preprocessor">#include &lt;QMenu&gt;</span>
<a name="l00063"></a>00063 
<a name="l00064"></a>00064 Q_DECLARE_METATYPE(<span class="keywordtype">unsigned</span>);
<a name="l00065"></a>00065 
<a name="l00066"></a>00066 <span class="keyword">namespace </span>{
<a name="l00067"></a>00067     <span class="keyword">struct </span>Init {
<a name="l00068"></a>00068         Init() {
<a name="l00069"></a>00069             qRegisterMetaType&lt;unsigned&gt;(<span class="stringliteral">"unsigned"</span>);
<a name="l00070"></a>00070         }
<a name="l00071"></a>00071     };
<a name="l00072"></a>00072 
<a name="l00073"></a>00073     Init * <span class="keyword">volatile</span> init = 0;
<a name="l00074"></a>00074 
<a name="l00075"></a>00075 
<a name="l00076"></a>00076     <span class="keyword">class </span>LogLineEvent : <span class="keyword">public</span> QEvent
<a name="l00077"></a>00077     {
<a name="l00078"></a>00078     <span class="keyword">public</span>:
<a name="l00079"></a>00079         LogLineEvent(<span class="keyword">const</span> QString &amp;str, <span class="keyword">const</span> QColor &amp; color)
<a name="l00080"></a>00080             : QEvent((QEvent::Type)<a class="code" href="classEmulApp.html" title="The central class to the program that more-or-less encapsulates most objects and...">EmulApp</a>::LogLineEventType), str(str), color(color)
<a name="l00081"></a>00081         {}
<a name="l00082"></a>00082         QString str;
<a name="l00083"></a>00083         QColor color;
<a name="l00084"></a>00084     };
<a name="l00085"></a>00085 
<a name="l00086"></a>00086     <span class="keyword">class </span>StatusMsgEvent : <span class="keyword">public</span> QEvent
<a name="l00087"></a>00087     {
<a name="l00088"></a>00088     <span class="keyword">public</span>:
<a name="l00089"></a>00089         StatusMsgEvent(<span class="keyword">const</span> QString &amp;msg, <span class="keywordtype">int</span> timeout)
<a name="l00090"></a>00090             : QEvent((QEvent::Type)<a class="code" href="classEmulApp.html" title="The central class to the program that more-or-less encapsulates most objects and...">EmulApp</a>::StatusMsgEventType), msg(msg), timeout(timeout)
<a name="l00091"></a>00091         {}
<a name="l00092"></a>00092         QString msg;
<a name="l00093"></a>00093         <span class="keywordtype">int</span> timeout;
<a name="l00094"></a>00094     };
<a name="l00095"></a>00095 
<a name="l00096"></a>00096     <span class="keyword">struct </span>SoundTrigListener
<a name="l00097"></a>00097     {
<a name="l00098"></a>00098         <span class="keyword">virtual</span> ~SoundTrigListener() {}
<a name="l00099"></a>00099         <span class="keyword">virtual</span> <span class="keywordtype">void</span> triggered(<span class="keywordtype">int</span> trig) = 0;
<a name="l00100"></a>00100     };
<a name="l00101"></a>00101 
<a name="l00102"></a>00102     <span class="keyword">struct </span>SoundListener
<a name="l00103"></a>00103     {
<a name="l00104"></a>00104         <span class="keyword">virtual</span> ~SoundListener() {}
<a name="l00105"></a>00105         <span class="keyword">virtual</span> <span class="keywordtype">void</span> gotSound(<span class="keywordtype">unsigned</span> <span class="keywordtype">id</span>) = 0;
<a name="l00106"></a>00106     };
<a name="l00107"></a>00107 
<a name="l00108"></a>00108     <span class="keyword">class </span>SoundTrigEvent : <span class="keyword">public</span> QEvent
<a name="l00109"></a>00109     {
<a name="l00110"></a>00110     <span class="keyword">public</span>:
<a name="l00111"></a>00111         SoundTrigEvent(<span class="keywordtype">int</span> trig, SoundTrigListener *listener = 0)
<a name="l00112"></a>00112             : QEvent((QEvent::Type)<a class="code" href="classEmulApp.html" title="The central class to the program that more-or-less encapsulates most objects and...">EmulApp</a>::SoundTrigEventType), trig(trig), listener(listener) {}
<a name="l00113"></a>00113         <span class="keywordtype">int</span> trig;
<a name="l00114"></a>00114         SoundTrigListener *listener;
<a name="l00115"></a>00115     };
<a name="l00116"></a>00116 
<a name="l00117"></a>00117     <span class="keyword">class </span>SoundEvent : <span class="keyword">public</span> QEvent
<a name="l00118"></a>00118     {
<a name="l00119"></a>00119     <span class="keyword">public</span>:
<a name="l00120"></a>00120         SoundEvent(<span class="keywordtype">unsigned</span> <span class="keywordtype">id</span>, QString name, <span class="keywordtype">bool</span> loops, SoundListener *listener = 0)
<a name="l00121"></a>00121             : QEvent((QEvent::Type)<a class="code" href="classEmulApp.html" title="The central class to the program that more-or-less encapsulates most objects and...">EmulApp</a>::SoundEventType), id(id), name(name), loops(loops), listener(listener) {}
<a name="l00122"></a>00122         <span class="keywordtype">unsigned</span> id;
<a name="l00123"></a>00123         QString name;
<a name="l00124"></a>00124         <span class="keywordtype">bool</span> loops;
<a name="l00125"></a>00125         SoundListener *listener;
<a name="l00126"></a>00126     };
<a name="l00127"></a>00127 
<a name="l00128"></a>00128     <span class="keyword">class </span>QuitEvent : <span class="keyword">public</span> QEvent
<a name="l00129"></a>00129     {
<a name="l00130"></a>00130     <span class="keyword">public</span>:
<a name="l00131"></a>00131         QuitEvent()
<a name="l00132"></a>00132             : QEvent((QEvent::Type)<a class="code" href="classEmulApp.html" title="The central class to the program that more-or-less encapsulates most objects and...">EmulApp</a>::QuitEventType)
<a name="l00133"></a>00133         {}
<a name="l00134"></a>00134     };
<a name="l00135"></a>00135 
<a name="l00136"></a>00136     <span class="keywordtype">bool</span> isSingleInstance()
<a name="l00137"></a>00137     {
<a name="l00138"></a>00138 <span class="preprocessor">#if defined(OS_LINUX) || defined(OS_OSX)</span>
<a name="l00139"></a>00139 <span class="preprocessor"></span>        return ::num_procs_of_my_exe_no_children() &lt;= 1;
<a name="l00140"></a>00140 <span class="preprocessor">#elif defined(OS_WINDOWS)</span>
<a name="l00141"></a>00141 <span class="preprocessor"></span>        HANDLE mut = CreateMutexA(NULL, FALSE, <span class="stringliteral">"Global\\FSMEmulator.exe.Mutex"</span>);
<a name="l00142"></a>00142         <span class="keywordflow">if</span> (mut) {
<a name="l00143"></a>00143             DWORD res = WaitForSingleObject(mut, 1000);
<a name="l00144"></a>00144             <span class="keywordflow">switch</span> (res) {
<a name="l00145"></a>00145             <span class="keywordflow">case</span> WAIT_ABANDONED:
<a name="l00146"></a>00146             <span class="keywordflow">case</span> WAIT_OBJECT_0:
<a name="l00147"></a>00147                 <span class="keywordflow">return</span> <span class="keyword">true</span>;
<a name="l00148"></a>00148             <span class="keywordflow">default</span>:
<a name="l00149"></a>00149                 <span class="keywordflow">return</span> <span class="keyword">false</span>;
<a name="l00150"></a>00150             }
<a name="l00151"></a>00151         }
<a name="l00152"></a>00152         <span class="comment">// note: handle stays open, which is ok, because when process terminates it will auto-close</span>
<a name="l00153"></a>00153 <span class="preprocessor">#endif</span>
<a name="l00154"></a>00154 <span class="preprocessor"></span>        <span class="keywordflow">return</span> <span class="keyword">true</span>;
<a name="l00155"></a>00155     }
<a name="l00156"></a>00156 
<a name="l00157"></a>00157 };
<a name="l00158"></a>00158 
<a name="l00159"></a>00159 <span class="keyword">class </span>SndThr : <span class="keyword">public</span> QThread, <span class="keyword">public</span> SoundTrigListener, <span class="keyword">public</span> SoundListener
<a name="l00160"></a>00160 
<a name="l00161"></a>00161 {
<a name="l00162"></a>00162     <span class="keyword">volatile</span> <span class="keywordtype">bool</span> pleaseStop, trigDone, sndDone;
<a name="l00163"></a>00163     <a class="code" href="classEmulApp.html" title="The central class to the program that more-or-less encapsulates most objects and...">EmulApp</a> *app;
<a name="l00164"></a>00164     SndShm *sndShm;
<a name="l00165"></a>00165     QMutex mut, mut2;
<a name="l00166"></a>00166     QWaitCondition cond, cond2;
<a name="l00167"></a>00167 <span class="keyword">public</span>:
<a name="l00168"></a>00168     SndThr(<a class="code" href="classEmulApp.html" title="The central class to the program that more-or-less encapsulates most objects and...">EmulApp</a> *parent);
<a name="l00169"></a>00169     ~SndThr();
<a name="l00170"></a>00170     <span class="keywordtype">void</span> triggered(<span class="keywordtype">int</span> trig);
<a name="l00171"></a>00171     <span class="keywordtype">void</span> gotSound(<span class="keywordtype">unsigned</span> <span class="keywordtype">id</span>);
<a name="l00172"></a>00172 <span class="keyword">protected</span>:
<a name="l00173"></a>00173     <span class="keywordtype">void</span> run();
<a name="l00174"></a>00174 };
<a name="l00175"></a>00175 
<a name="l00176"></a>00176 SndThr::SndThr(<a class="code" href="classEmulApp.html" title="The central class to the program that more-or-less encapsulates most objects and...">EmulApp</a> *parent)
<a name="l00177"></a>00177     : QThread(parent), pleaseStop(false), trigDone(false), sndDone(false), app(parent), sndShm(0)
<a name="l00178"></a>00178 {
<a name="l00179"></a>00179         RTOS::ShmStatus shmStatus;
<a name="l00180"></a>00180         <span class="comment">// do sound shm stuff..</span>
<a name="l00181"></a>00181         sndShm = <span class="keyword">reinterpret_cast&lt;</span>SndShm *<span class="keyword">&gt;</span>(RTOS::shmAttach(SND_SHM_NAME, SND_SHM_SIZE, &amp;shmStatus, <span class="keyword">true</span>));
<a name="l00182"></a>00182         <span class="keywordflow">if</span> (!sndShm) {
<a name="l00183"></a>00183             <span class="keywordflow">throw</span> FatalException(QString(<span class="stringliteral">"Cannot create shm to "</span>) + SND_SHM_NAME + <span class="stringliteral">" reason was: "</span> + RTOS::statusString(shmStatus));
<a name="l00184"></a>00184         }
<a name="l00185"></a>00185         memset(sndShm, 0, SND_SHM_SIZE);
<a name="l00186"></a>00186         sndShm-&gt;fifo_in[0] = sndShm-&gt;fifo_out[0] = -1;
<a name="l00187"></a>00187         sndShm-&gt;magic = SND_SHM_MAGIC;
<a name="l00188"></a>00188         *<span class="keyword">const_cast&lt;</span><span class="keywordtype">unsigned</span> *<span class="keyword">&gt;</span>(&amp;sndShm-&gt;num_cards) = 1;
<a name="l00189"></a>00189         <span class="keywordtype">unsigned</span> minor;
<a name="l00190"></a>00190         <span class="keywordflow">if</span> (RTOS::createFifo(minor, SND_FIFO_SZ) == RTOS::INVALID_FIFO) 
<a name="l00191"></a>00191             <span class="keywordflow">throw</span> FatalException(QString(<span class="stringliteral">"Cannot create out fifo for SndShm"</span>));
<a name="l00192"></a>00192         sndShm-&gt;fifo_out[0] = minor;
<a name="l00193"></a>00193         <span class="keywordflow">if</span> (RTOS::createFifo(minor, SND_FIFO_SZ) == RTOS::INVALID_FIFO) 
<a name="l00194"></a>00194             <span class="keywordflow">throw</span> FatalException(QString(<span class="stringliteral">"Cannot create in fifo for SndShm"</span>));
<a name="l00195"></a>00195         sndShm-&gt;fifo_in[0] = minor;
<a name="l00196"></a>00196         <a class="code" href="classDebug.html" title="Stream-like class to print a debug message to the app&amp;#39;s console window Example:...">Debug</a>() &lt;&lt; <span class="stringliteral">"Sound Shm FIFOs -  In: "</span> &lt;&lt; sndShm-&gt;fifo_in[0] &lt;&lt; <span class="stringliteral">"  Out: "</span> &lt;&lt; sndShm-&gt;fifo_out[0];
<a name="l00197"></a>00197 }
<a name="l00198"></a>00198 
<a name="l00199"></a>00199 SndThr::~SndThr()
<a name="l00200"></a>00200 {
<a name="l00201"></a>00201     pleaseStop = <span class="keyword">true</span>;
<a name="l00202"></a>00202     <span class="keywordflow">if</span> (!wait(2000))
<a name="l00203"></a>00203         terminate();    
<a name="l00204"></a>00204     <span class="keywordflow">if</span> (sndShm) {
<a name="l00205"></a>00205         <span class="keywordflow">if</span> (sndShm-&gt;fifo_out[0] &gt; -1) {
<a name="l00206"></a>00206             RTOS::closeFifo(sndShm-&gt;fifo_out[0]);
<a name="l00207"></a>00207             sndShm-&gt;fifo_out[0] = -1;
<a name="l00208"></a>00208         }
<a name="l00209"></a>00209         <span class="keywordflow">if</span> (sndShm-&gt;fifo_in[0] &gt; -1) {
<a name="l00210"></a>00210             RTOS::closeFifo(sndShm-&gt;fifo_in[0]);
<a name="l00211"></a>00211             sndShm-&gt;fifo_in[0] = -1;
<a name="l00212"></a>00212         }
<a name="l00213"></a>00213         memset((<span class="keywordtype">void</span> *)sndShm, 0, <span class="keyword">sizeof</span>(*sndShm));
<a name="l00214"></a>00214         RTOS::shmDetach(sndShm, 0, <span class="keyword">true</span>);
<a name="l00215"></a>00215         sndShm = 0;
<a name="l00216"></a>00216     }
<a name="l00217"></a>00217 }
<a name="l00218"></a>00218 
<a name="l00219"></a>00219 <span class="keywordtype">void</span> SndThr::run()
<a name="l00220"></a>00220 {
<a name="l00221"></a>00221     <span class="keywordflow">while</span> (!pleaseStop) {
<a name="l00222"></a>00222         <span class="keywordflow">if</span> (RTOS::waitReadFifo(sndShm-&gt;fifo_in[0], 200)) {
<a name="l00223"></a>00223             SndFifoNotify_t dummy;
<a name="l00224"></a>00224             <span class="keywordflow">if</span> (RTOS::readFifo(sndShm-&gt;fifo_in[0], &amp;dummy, <span class="keyword">sizeof</span>(dummy), <span class="keyword">false</span>) == <span class="keyword">sizeof</span>(dummy)) {
<a name="l00225"></a>00225                 <span class="keywordtype">bool</span> do_reply = <span class="keyword">false</span>;
<a name="l00226"></a>00226                 <span class="keywordflow">switch</span>(sndShm-&gt;msg[0].id) {
<a name="l00227"></a>00227                 <span class="keywordflow">case</span> GETLASTEVENT:
<a name="l00228"></a>00228                     sndShm-&gt;msg[0].u.last_event = app-&gt;lastSndEvt;
<a name="l00229"></a>00229                     do_reply = <span class="keyword">true</span>;
<a name="l00230"></a>00230                     <span class="keywordflow">break</span>;
<a name="l00231"></a>00231                 <span class="keywordflow">case</span> FORCEEVENT: {
<a name="l00232"></a>00232                     <span class="keywordtype">int</span> trig = app-&gt;lastSndEvt = sndShm-&gt;msg[0].u.forced_event;
<a name="l00233"></a>00233                     <a class="code" href="classDebug.html" title="Stream-like class to print a debug message to the app&amp;#39;s console window Example:...">Debug</a>() &lt;&lt; <span class="stringliteral">"Got sound trigger "</span> &lt;&lt; trig &lt;&lt; <span class="stringliteral">" in EmulApp manual trigger thread."</span>;
<a name="l00234"></a>00234                     trigDone = <span class="keyword">false</span>;
<a name="l00235"></a>00235                     QCoreApplication::postEvent(app, <span class="keyword">new</span> SoundTrigEvent(trig, <span class="keyword">this</span>));                    
<a name="l00236"></a>00236                     mut.lock();
<a name="l00237"></a>00237                     <span class="keywordflow">if</span> (!trigDone) {
<a name="l00238"></a>00238                         cond.wait(&amp;mut); <span class="comment">// wait forever for the trigdone!</span>
<a name="l00239"></a>00239                     }
<a name="l00240"></a>00240                     mut.unlock();
<a name="l00241"></a>00241                     do_reply = <span class="keyword">true</span>;
<a name="l00242"></a>00242                 }
<a name="l00243"></a>00243                     <span class="keywordflow">break</span>;
<a name="l00244"></a>00244                 <span class="keywordflow">case</span> SOUND: { <span class="comment">// notified of a new sound.. note the sound now lives on the filesystem</span>
<a name="l00245"></a>00245                     <span class="keywordtype">unsigned</span> <span class="keywordtype">id</span> = sndShm-&gt;msg[0].u.sound.id;
<a name="l00246"></a>00246                     QString fname(sndShm-&gt;msg[0].u.sound.databuf);
<a name="l00247"></a>00247                     <span class="keywordtype">bool</span> islooped = sndShm-&gt;msg[0].u.sound.is_looped;
<a name="l00248"></a>00248                     <a class="code" href="classDebug.html" title="Stream-like class to print a debug message to the app&amp;#39;s console window Example:...">Debug</a>() &lt;&lt; <span class="stringliteral">"Got new sound "</span> &lt;&lt; <span class="keywordtype">id</span> &lt;&lt; <span class="stringliteral">": `"</span> &lt;&lt; fname &lt;&lt; <span class="stringliteral">"' in EmulApp SndThr."</span>;
<a name="l00249"></a>00249                     sndDone = <span class="keyword">false</span>;
<a name="l00250"></a>00250                     QCoreApplication::postEvent(app, <span class="keyword">new</span> SoundEvent(<span class="keywordtype">id</span>, fname, islooped, <span class="keyword">this</span>));                    
<a name="l00251"></a>00251                     mut2.lock();
<a name="l00252"></a>00252                     <span class="keywordflow">if</span> (!sndDone) {
<a name="l00253"></a>00253                         cond2.wait(&amp;mut2); <span class="comment">// wait forever for the trigdone!</span>
<a name="l00254"></a>00254                     }
<a name="l00255"></a>00255                     mut2.unlock();
<a name="l00256"></a>00256                     do_reply = <span class="keyword">true</span>;                    
<a name="l00257"></a>00257                 }
<a name="l00258"></a>00258                     <span class="keywordflow">break</span>;
<a name="l00259"></a>00259                 }
<a name="l00260"></a>00260                 <span class="keywordflow">if</span> (do_reply) {
<a name="l00261"></a>00261                     dummy = 1;                    
<a name="l00262"></a>00262                     RTOS::writeFifo(sndShm-&gt;fifo_out[0], &amp;dummy, <span class="keyword">sizeof</span>(dummy), <span class="keyword">true</span>);
<a name="l00263"></a>00263                 }
<a name="l00264"></a>00264             }
<a name="l00265"></a>00265         }
<a name="l00266"></a>00266     }
<a name="l00267"></a>00267 }
<a name="l00268"></a>00268 
<a name="l00269"></a>00269 <span class="keywordtype">void</span> SndThr::triggered(<span class="keywordtype">int</span> trig)
<a name="l00270"></a>00270 {
<a name="l00271"></a>00271     (void)trig;
<a name="l00272"></a>00272     mut.lock();
<a name="l00273"></a>00273     trigDone = <span class="keyword">true</span>;
<a name="l00274"></a>00274     mut.unlock();
<a name="l00275"></a>00275     <span class="comment">//Debug() &lt;&lt; "EmulApp manual trigger thread will be woken up for trigger " &lt;&lt; trig;</span>
<a name="l00276"></a>00276     cond.wakeAll();
<a name="l00277"></a>00277 }
<a name="l00278"></a>00278 
<a name="l00279"></a>00279 <span class="keywordtype">void</span> SndThr::gotSound(<span class="keywordtype">unsigned</span> <span class="keywordtype">id</span>)
<a name="l00280"></a>00280 {
<a name="l00281"></a>00281     (void)<span class="keywordtype">id</span>;
<a name="l00282"></a>00282     mut2.lock();
<a name="l00283"></a>00283     sndDone = <span class="keyword">true</span>;
<a name="l00284"></a>00284     mut2.unlock();
<a name="l00285"></a>00285     <span class="comment">//Debug() &lt;&lt; "EmulApp manual trigger thread will be woken up for trigger " &lt;&lt; trig;</span>
<a name="l00286"></a>00286     cond2.wakeAll();
<a name="l00287"></a>00287 }
<a name="l00288"></a>00288 
<a name="l00289"></a>00289 <a class="code" href="classEmulApp.html" title="The central class to the program that more-or-less encapsulates most objects and...">EmulApp</a> * EmulApp::singleton = 0;
<a name="l00290"></a>00290 
<a name="l00291"></a>00291 EmulApp::EmulApp(<span class="keywordtype">int</span> &amp; argc, <span class="keywordtype">char</span> ** argv)
<a name="l00292"></a>00292     : QApplication(argc, argv, true), fsmPrintFunctor(0), debug(false), initializing(true), nLinesInLog(0), nLinesInLogMax(1000), fsmRunning(false), fsmServerProc(0), soundServerProc(0), soundTrigShm(0), sndThr(0), lastSndEvt(0)
<a name="l00293"></a>00293 {
<a name="l00294"></a>00294     <span class="keywordflow">if</span> (!isSingleInstance()) {
<a name="l00295"></a>00295         QMessageBox::critical(0, <span class="stringliteral">"FSM Emulator - Error"</span>, <span class="stringliteral">"Another copy of this program is already running!"</span>);
<a name="l00296"></a>00296         std::exit(1);
<a name="l00297"></a>00297     }
<a name="l00298"></a>00298     <span class="keywordflow">if</span> (singleton) {
<a name="l00299"></a>00299         QMessageBox::critical(0, <span class="stringliteral">"FSM Emulator - Invariant Violation"</span>, <span class="stringliteral">"Only 1 instance of EmulApp allowed per application!"</span>);
<a name="l00300"></a>00300         std::exit(1);
<a name="l00301"></a>00301     }
<a name="l00302"></a>00302     singleton = <span class="keyword">this</span>;
<a name="l00303"></a>00303     setApplicationName(<span class="stringliteral">"FSMEmulator"</span>);
<a name="l00304"></a>00304     <span class="keywordflow">try</span> {
<a name="l00305"></a>00305 
<a name="l00306"></a>00306         <span class="keywordflow">if</span> (!::init) ::init = <span class="keyword">new</span> Init;
<a name="l00307"></a>00307         loadSettings();
<a name="l00308"></a>00308 
<a name="l00309"></a>00309         installEventFilter(<span class="keyword">this</span>); <span class="comment">// filter our own events</span>
<a name="l00310"></a>00310 
<a name="l00311"></a>00311         mainwin = <span class="keyword">new</span> MainWindow;
<a name="l00312"></a>00312         defaultLogColor = mainwin-&gt;textEdit()-&gt;textColor();
<a name="l00313"></a>00313 
<a name="l00314"></a>00314         <a class="code" href="classLog.html" title="Super class of Debug, Warning, Error classes.">Log</a>() &lt;&lt; <span class="stringliteral">"Application started"</span>;
<a name="l00315"></a>00315 
<a name="l00316"></a>00316         mainwin-&gt;installEventFilter(<span class="keyword">this</span>);
<a name="l00317"></a>00317         mainwin-&gt;textEdit()-&gt;installEventFilter(<span class="keyword">this</span>);
<a name="l00318"></a>00318 
<a name="l00319"></a>00319         mainwin-&gt;setWindowTitle(<span class="stringliteral">"FSM Emulator v."</span> VersionSTR);
<a name="l00320"></a>00320         mainwin-&gt;resize(600, 300);
<a name="l00321"></a>00321         <span class="keywordtype">int</span> delta = 0;
<a name="l00322"></a>00322 <span class="preprocessor">#ifdef Q_WS_X11</span>
<a name="l00323"></a>00323 <span class="preprocessor"></span>        delta += 22; <span class="comment">// this is a rough guesstimate to correct for window frame size being unknown on X11</span>
<a name="l00324"></a>00324 <span class="preprocessor">#endif</span>
<a name="l00325"></a>00325 <span class="preprocessor"></span>        mainwin-&gt;move(0,mainwin-&gt;frameSize().height()+delta);
<a name="l00326"></a>00326         mainwin-&gt;show();
<a name="l00327"></a>00327         
<a name="l00328"></a>00328         <span class="comment">// do sound trig shm stuff..</span>
<a name="l00329"></a>00329         RTOS::ShmStatus shmStatus;
<a name="l00330"></a>00330         soundTrigShm = <span class="keyword">reinterpret_cast&lt;</span>FSMExtTrigShm *<span class="keyword">&gt;</span>(RTOS::shmAttach(FSM_EXT_TRIG_SHM_NAME, FSM_EXT_TRIG_SHM_SIZE, &amp;shmStatus, <span class="keyword">true</span>));
<a name="l00331"></a>00331         <span class="keywordflow">if</span> (!soundTrigShm) {
<a name="l00332"></a>00332             <span class="keywordflow">throw</span> FatalException(QString(<span class="stringliteral">"Cannot create shm to "</span>) + FSM_EXT_TRIG_SHM_NAME + <span class="stringliteral">" reason was: "</span> + RTOS::statusString(shmStatus));
<a name="l00333"></a>00333         }
<a name="l00334"></a>00334         soundTrigShm-&gt;magic = FSM_EXT_TRIG_SHM_MAGIC;
<a name="l00335"></a>00335         soundTrigShm-&gt;function = &amp;EmulApp::soundTrigFunc;
<a name="l00336"></a>00336         soundTrigShm-&gt;valid = 1;
<a name="l00337"></a>00337 
<a name="l00338"></a>00338         killProcs(<span class="stringliteral">"FSMServer"</span>);
<a name="l00339"></a>00339         killProcs(<span class="stringliteral">"SoundServer"</span>);
<a name="l00340"></a>00340 
<a name="l00341"></a>00341         startFSM();
<a name="l00342"></a>00342         startFSMServer();
<a name="l00343"></a>00343         startSoundServer();
<a name="l00344"></a>00344 
<a name="l00345"></a>00345         pfv = <span class="keyword">new</span> ProcFileViewer(0);
<a name="l00346"></a>00346         pfv-&gt;resize(516, 621);
<a name="l00347"></a>00347         pfv-&gt;hide();
<a name="l00348"></a>00348         
<a name="l00350"></a>00350         mpv = <span class="keyword">new</span> QWidget(0);
<a name="l00351"></a>00351         mpv-&gt;setWindowTitle(<span class="stringliteral">"FSM Emulator - Module Parameter Viewer"</span>);
<a name="l00352"></a>00352         QGridLayout *l = <span class="keyword">new</span> QGridLayout(mpv);
<a name="l00353"></a>00353         QScrollArea *qsa = <span class="keyword">new</span> QScrollArea(mpv);
<a name="l00354"></a>00354         mp = <span class="keyword">new</span> ModuleParmView(qsa);        
<a name="l00355"></a>00355         qsa-&gt;setWidget(mp);
<a name="l00356"></a>00356         qsa-&gt;setWidgetResizable(<span class="keyword">true</span>);
<a name="l00357"></a>00357         l-&gt;addWidget(<span class="keyword">new</span> QLabel(<span class="stringliteral">"Modify FSM module parameters here, note that applying the parameters &lt;B&gt;&lt;font color=red&gt;*will*&lt;/b&gt;&lt;/font&gt; force an FSM restart!"</span>, mpv), 0, 0, 1, 3);
<a name="l00358"></a>00358         l-&gt;addWidget(qsa, 1, 0, 1, 3);
<a name="l00359"></a>00359         applyParamsBut = <span class="keyword">new</span> QPushButton(<span class="stringliteral">"Apply"</span>, mpv);
<a name="l00360"></a>00360         applyParamsBut-&gt;setEnabled(<span class="keyword">false</span>);
<a name="l00361"></a>00361         revertParamsBut = <span class="keyword">new</span> QPushButton(<span class="stringliteral">"Revert"</span>, mpv);
<a name="l00362"></a>00362         revertParamsBut-&gt;setEnabled(<span class="keyword">false</span>);
<a name="l00363"></a>00363         
<a name="l00364"></a>00364         l-&gt;addWidget(applyParamsBut, 2, 0, 1, 1, Qt::AlignLeft);
<a name="l00365"></a>00365         l-&gt;addWidget(revertParamsBut, 2, 1, 1, 1, Qt::AlignLeft);
<a name="l00366"></a>00366         l-&gt;addWidget(<span class="keyword">new</span> QWidget(mpv), 2, 2, 1, 1);
<a name="l00367"></a>00367         connect(applyParamsBut, SIGNAL(clicked()), <span class="keyword">this</span>, SLOT(applyModParams()));
<a name="l00368"></a>00368         connect(revertParamsBut, SIGNAL(clicked()), <span class="keyword">this</span>, SLOT(revertModParams()));
<a name="l00369"></a>00369         connect(mp, SIGNAL(changed()), <span class="keyword">this</span>, SLOT(modParamsChanged()));
<a name="l00370"></a>00370 
<a name="l00371"></a>00371         <span class="comment">// construct the control window</span>
<a name="l00372"></a>00372         controlwin = <span class="keyword">new</span> ControlWin(0);
<a name="l00373"></a>00373         controlwin-&gt;show();
<a name="l00374"></a>00374 
<a name="l00375"></a>00375         setupAppIcon();
<a name="l00376"></a>00376         buildAppMenus();
<a name="l00377"></a>00377         
<a name="l00378"></a>00378         initializing = <span class="keyword">false</span>;
<a name="l00379"></a>00379 
<a name="l00380"></a>00380         <a class="code" href="classLog.html" title="Super class of Debug, Warning, Error classes.">Log</a>() &lt;&lt; <span class="stringliteral">"Application initialized"</span>;    
<a name="l00381"></a>00381 
<a name="l00382"></a>00382         QTimer *timer = <span class="keyword">new</span> QTimer(<span class="keyword">this</span>);
<a name="l00383"></a>00383         connect(timer, SIGNAL(timeout()), <span class="keyword">this</span>, SLOT(updateStatusBar()));
<a name="l00384"></a>00384         timer-&gt;setSingleShot(<span class="keyword">false</span>);
<a name="l00385"></a>00385         timer-&gt;start(247); <span class="comment">// update status bar every 247ms.. i like this non-round-numbre.. ;)</span>
<a name="l00386"></a>00386 
<a name="l00387"></a>00387     } <span class="keywordflow">catch</span> (<span class="keyword">const</span> Exception &amp; e) {
<a name="l00388"></a>00388         <a class="code" href="classError.html" title="Stream-like class to print an error message to the app&amp;#39;s console window Example:...">Error</a>() &lt;&lt; e.what() &lt;&lt; <span class="stringliteral">"\n"</span>;
<a name="l00389"></a>00389         QMessageBox::critical(0, <span class="stringliteral">"FSM Emulator - Exception Caught"</span>, e.what());
<a name="l00390"></a>00390         postEvent(mainwin, <span class="keyword">new</span> QCloseEvent());
<a name="l00391"></a>00391     }
<a name="l00392"></a>00392 }
<a name="l00393"></a>00393 
<a name="l00394"></a>00394 EmulApp::~EmulApp()
<a name="l00395"></a>00395 {
<a name="l00396"></a>00396     stopSoundServer();
<a name="l00397"></a>00397     stopFSMServer();
<a name="l00398"></a>00398     stopFSM();    
<a name="l00399"></a>00399 
<a name="l00400"></a>00400     <span class="keywordflow">if</span> (soundTrigShm) {
<a name="l00401"></a>00401         memset(soundTrigShm, 0, <span class="keyword">sizeof</span> *soundTrigShm);
<a name="l00402"></a>00402         RTOS::shmDetach(soundTrigShm, 0, <span class="keyword">true</span>);
<a name="l00403"></a>00403         soundTrigShm = 0;
<a name="l00404"></a>00404     }
<a name="l00405"></a>00405     <span class="keywordflow">if</span> (sndThr) <span class="keyword">delete</span> sndThr, sndThr = 0;
<a name="l00406"></a>00406     <a class="code" href="classLog.html" title="Super class of Debug, Warning, Error classes.">Log</a>() &lt;&lt; <span class="stringliteral">"Exiting.."</span>;
<a name="l00407"></a>00407     saveSettings();
<a name="l00408"></a>00408     singleton = 0;
<a name="l00409"></a>00409 }
<a name="l00410"></a>00410 
<a name="l00411"></a><a class="code" href="classEmulApp.html#0b6be73c5b64502d0589f8cac2d252cb">00411</a> <span class="keywordtype">bool</span> <a class="code" href="classEmulApp.html#0b6be73c5b64502d0589f8cac2d252cb" title="Returns true iff the application&amp;#39;s console window has debug output printing enabled...">EmulApp::isDebugMode</a>()<span class="keyword"> const</span>
<a name="l00412"></a>00412 <span class="keyword"></span>{
<a name="l00413"></a>00413     <span class="keywordflow">return</span> debug;
<a name="l00414"></a>00414 }
<a name="l00415"></a>00415 
<a name="l00416"></a><a class="code" href="classEmulApp.html#3fa9a6ca873e638d469b2faabe0ac123">00416</a> <span class="keywordtype">void</span> <a class="code" href="classEmulApp.html#3fa9a6ca873e638d469b2faabe0ac123" title="Set/unset the application-wide &amp;#39;debug&amp;#39; mode setting. If the application is...">EmulApp::setDebugMode</a>(<span class="keywordtype">bool</span> d)
<a name="l00417"></a>00417 {
<a name="l00418"></a>00418     debug = d;
<a name="l00419"></a>00419     saveSettings();
<a name="l00420"></a>00420 }
<a name="l00421"></a>00421 
<a name="l00422"></a><a class="code" href="classEmulApp.html#660011d09186b6ae53f4a3b52f7f954b">00422</a> <span class="keywordtype">bool</span> <a class="code" href="classEmulApp.html#660011d09186b6ae53f4a3b52f7f954b" title="Used to catch various events from other threads, etc.">EmulApp::eventFilter</a>(QObject *watched, QEvent *event)
<a name="l00423"></a>00423 {
<a name="l00424"></a>00424     <span class="keywordtype">int</span> type = <span class="keyword">static_cast&lt;</span><span class="keywordtype">int</span><span class="keyword">&gt;</span>(<span class="keyword">event</span>-&gt;type());
<a name="l00425"></a>00425     <span class="keywordflow">if</span> (type == QEvent::KeyPress) {
<a name="l00426"></a>00426     } 
<a name="l00427"></a>00427     MainWindow *mw = <span class="keyword">dynamic_cast&lt;</span>MainWindow *<span class="keyword">&gt;</span>(watched);
<a name="l00428"></a>00428     <span class="keywordflow">if</span> (mw) {
<a name="l00429"></a>00429         <span class="keywordflow">if</span> (type == <a class="code" href="classEmulApp.html#303c04f66d16a041b2d18e29cd4d5e2df88bac98a996141d8c38c8d48af1afc7" title="used to catch log line events see EmulApp.cpp">LogLineEventType</a>) {
<a name="l00430"></a>00430             LogLineEvent *evt = <span class="keyword">dynamic_cast&lt;</span>LogLineEvent *<span class="keyword">&gt;</span>(event);
<a name="l00431"></a>00431             <span class="keywordflow">if</span> (evt &amp;&amp; mw-&gt;textEdit()) {
<a name="l00432"></a>00432                 QTextEdit *te = mw-&gt;textEdit();
<a name="l00433"></a>00433                 QColor origcolor = te-&gt;textColor();
<a name="l00434"></a>00434                 te-&gt;setTextColor(evt-&gt;color);
<a name="l00435"></a>00435                 te-&gt;append(evt-&gt;str);
<a name="l00436"></a>00436 
<a name="l00437"></a>00437                 <span class="comment">// make sure the log textedit doesn't grow forever</span>
<a name="l00438"></a>00438                 <span class="comment">// so prune old lines when a threshold is hit</span>
<a name="l00439"></a>00439                 nLinesInLog += evt-&gt;str.split(<span class="stringliteral">"\n"</span>).size();
<a name="l00440"></a>00440                 <span class="keywordflow">if</span> (nLinesInLog &gt; nLinesInLogMax) {
<a name="l00441"></a>00441                     <span class="keyword">const</span> <span class="keywordtype">int</span> n2del = MAX(nLinesInLogMax/10, nLinesInLog-nLinesInLogMax);
<a name="l00442"></a>00442                     QTextCursor cursor = te-&gt;textCursor();
<a name="l00443"></a>00443                     cursor.movePosition(QTextCursor::Start);
<a name="l00444"></a>00444                     <span class="keywordflow">for</span> (<span class="keywordtype">int</span> i = 0; i &lt; n2del; ++i) {
<a name="l00445"></a>00445                         cursor.movePosition(QTextCursor::Down, QTextCursor::KeepAnchor);
<a name="l00446"></a>00446                     }
<a name="l00447"></a>00447                     cursor.removeSelectedText(); <span class="comment">// deletes the lines, leaves a blank line</span>
<a name="l00448"></a>00448                     nLinesInLog -= n2del;
<a name="l00449"></a>00449                 }
<a name="l00450"></a>00450 
<a name="l00451"></a>00451                 te-&gt;setTextColor(origcolor);
<a name="l00452"></a>00452                 te-&gt;moveCursor(QTextCursor::End);
<a name="l00453"></a>00453                 te-&gt;ensureCursorVisible();
<a name="l00454"></a>00454                 <span class="keywordflow">return</span> <span class="keyword">true</span>;
<a name="l00455"></a>00455             } <span class="keywordflow">else</span> {
<a name="l00456"></a>00456                 <span class="keywordflow">return</span> <span class="keyword">false</span>;
<a name="l00457"></a>00457             }
<a name="l00458"></a>00458         } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (type == <a class="code" href="classEmulApp.html#303c04f66d16a041b2d18e29cd4d5e2dab0b48614c5d6c36686b4e45c88786dd" title="used to indicate the event contains a status message for the status bar">StatusMsgEventType</a>) {
<a name="l00459"></a>00459             StatusMsgEvent *evt = <span class="keyword">dynamic_cast&lt;</span>StatusMsgEvent *<span class="keyword">&gt;</span>(event);
<a name="l00460"></a>00460             <span class="keywordflow">if</span> (evt &amp;&amp; mw-&gt;statusBar()) {
<a name="l00461"></a>00461                 mw-&gt;statusBar()-&gt;showMessage(evt-&gt;msg, evt-&gt;timeout);
<a name="l00462"></a>00462                 <span class="keywordflow">return</span> <span class="keyword">true</span>;
<a name="l00463"></a>00463             } <span class="keywordflow">else</span> {
<a name="l00464"></a>00464                 <span class="keywordflow">return</span> <span class="keyword">false</span>;
<a name="l00465"></a>00465             }
<a name="l00466"></a>00466         }
<a name="l00467"></a>00467     }
<a name="l00468"></a>00468     <span class="keywordflow">if</span> (watched == <span class="keyword">this</span>) {
<a name="l00469"></a>00469         <span class="keywordflow">if</span> (type == <a class="code" href="classEmulApp.html#303c04f66d16a041b2d18e29cd4d5e2dbca5931edc20aecbe14bdc2c3e4a3d79" title="so we can post quit events..">QuitEventType</a>) {
<a name="l00470"></a>00470             quit();
<a name="l00471"></a>00471             <span class="keywordflow">return</span> <span class="keyword">true</span>;
<a name="l00472"></a>00472         }
<a name="l00473"></a>00473         <span class="keywordflow">if</span> (type == <a class="code" href="classEmulApp.html#303c04f66d16a041b2d18e29cd4d5e2dfab573322fd03abb938b771077b72645" title="so we can post sound trigger events...">SoundTrigEventType</a>) {
<a name="l00474"></a>00474             SoundTrigEvent *evt = <span class="keyword">dynamic_cast&lt;</span>SoundTrigEvent *<span class="keyword">&gt;</span>(event);
<a name="l00475"></a>00475             <span class="keywordflow">if</span> (evt) trigSound(evt-&gt;trig);
<a name="l00476"></a>00476             <span class="keywordflow">if</span> (evt-&gt;listener) evt-&gt;listener-&gt;triggered(evt-&gt;trig);
<a name="l00477"></a>00477             <span class="keywordflow">return</span> <span class="keyword">true</span>;
<a name="l00478"></a>00478         }
<a name="l00479"></a>00479         <span class="keywordflow">if</span> (type == SoundEventType) {
<a name="l00480"></a>00480             SoundEvent *evt = <span class="keyword">dynamic_cast&lt;</span>SoundEvent *<span class="keyword">&gt;</span>(event);
<a name="l00481"></a>00481             <span class="keywordflow">if</span> (evt) gotSound(evt-&gt;id, evt-&gt;name, evt-&gt;loops);
<a name="l00482"></a>00482             <span class="keywordflow">if</span> (evt-&gt;listener) evt-&gt;listener-&gt;gotSound(evt-&gt;id);
<a name="l00483"></a>00483             <span class="keywordflow">return</span> <span class="keyword">true</span>;
<a name="l00484"></a>00484         }
<a name="l00485"></a>00485     }
<a name="l00486"></a>00486     <span class="comment">// otherwise do default action for event which probably means</span>
<a name="l00487"></a>00487     <span class="comment">// propagate it down</span>
<a name="l00488"></a>00488     <span class="keywordflow">return</span> QApplication::eventFilter(watched, event);
<a name="l00489"></a>00489 }
<a name="l00490"></a>00490 
<a name="l00491"></a><a class="code" href="classEmulApp.html#eed117d40c6220478c7a58d96a93a2f7">00491</a> <span class="keywordtype">void</span> <a class="code" href="classEmulApp.html#eed117d40c6220478c7a58d96a93a2f7" title="Thread-safe logging -- logs a line to the log window in a thread-safe manner.">EmulApp::logLine</a>(<span class="keyword">const</span> QString &amp; line, <span class="keyword">const</span> QColor &amp; c)
<a name="l00492"></a>00492 {
<a name="l00493"></a>00493     qApp-&gt;postEvent(mainwin, <span class="keyword">new</span> LogLineEvent(line, c.isValid() ? c : defaultLogColor));
<a name="l00494"></a>00494 }
<a name="l00495"></a>00495 
<a name="l00496"></a>00496 
<a name="l00497"></a>00497 <span class="keywordtype">void</span> EmulApp::loadSettings()
<a name="l00498"></a>00498 {
<a name="l00499"></a>00499     mut.lock();
<a name="l00500"></a>00500     QSettings settings(<span class="stringliteral">"brodylab.princeton.edu"</span>, <span class="stringliteral">"FSMEmulator"</span>);
<a name="l00501"></a>00501     settings.beginGroup(<span class="stringliteral">"EmulApp"</span>);
<a name="l00502"></a>00502 
<a name="l00503"></a>00503     <span class="keyword">const</span> Emul::ModuleParmMap &amp; m = Emul::getModuleParms();
<a name="l00504"></a>00504     <span class="keywordflow">for</span> (Emul::ModuleParmMap::const_iterator it = m.begin(); it != m.end(); ++it) {
<a name="l00505"></a>00505         <span class="keywordflow">switch</span>(it-&gt;second.type) {
<a name="l00506"></a>00506         <span class="keywordflow">case</span> Emul::ModuleParm::Int: {
<a name="l00507"></a>00507             <span class="keywordtype">int</span> &amp; i = *<span class="keyword">const_cast&lt;</span><span class="keywordtype">int</span> *<span class="keyword">&gt;</span>(<span class="keyword">reinterpret_cast&lt;</span><span class="keyword">const </span><span class="keywordtype">int</span> *<span class="keyword">&gt;</span>(it-&gt;second.p));
<a name="l00508"></a>00508             <span class="keywordtype">int</span> def = i;
<a name="l00509"></a>00509             <span class="keywordflow">if</span> (it-&gt;first == <span class="stringliteral">"task_rate"</span>) def = 60;
<a name="l00510"></a>00510             <span class="keywordflow">if</span> (it-&gt;first == <span class="stringliteral">"debug"</span>) def = <span class="keyword">true</span>;
<a name="l00511"></a>00511             i = settings.value(QString(<span class="stringliteral">"mp_"</span>) + it-&gt;first.c_str(), def).toInt();
<a name="l00512"></a>00512             <span class="keywordflow">if</span> (it-&gt;first == <span class="stringliteral">"debug"</span>) debug = i;
<a name="l00513"></a>00513             <span class="keywordflow">break</span>;
<a name="l00514"></a>00514         }
<a name="l00515"></a>00515         <span class="keywordflow">default</span>: <span class="keywordflow">break</span>;
<a name="l00516"></a>00516         }
<a name="l00517"></a>00517     }
<a name="l00518"></a>00518     mut.unlock();
<a name="l00519"></a>00519 }
<a name="l00520"></a>00520 
<a name="l00521"></a>00521 <span class="keywordtype">void</span> EmulApp::saveSettings()
<a name="l00522"></a>00522 {
<a name="l00523"></a>00523     mut.lock();
<a name="l00524"></a>00524     QSettings settings(<span class="stringliteral">"brodylab.princeton.edu"</span>, <span class="stringliteral">"FSMEmulator"</span>);
<a name="l00525"></a>00525     settings.beginGroup(<span class="stringliteral">"EmulApp"</span>);
<a name="l00526"></a>00526     <span class="keyword">const</span> Emul::ModuleParmMap &amp; m = Emul::getModuleParms();
<a name="l00527"></a>00527     <span class="keywordflow">for</span> (Emul::ModuleParmMap::const_iterator it = m.begin(); it != m.end(); ++it) {
<a name="l00528"></a>00528         <span class="keywordflow">switch</span>(it-&gt;second.type) {
<a name="l00529"></a>00529         <span class="keywordflow">case</span> Emul::ModuleParm::Int: {
<a name="l00530"></a>00530             <span class="keyword">const</span> <span class="keywordtype">int</span> &amp; i = *<span class="keyword">reinterpret_cast&lt;</span><span class="keyword">const </span><span class="keywordtype">int</span> *<span class="keyword">&gt;</span>(it-&gt;second.p);
<a name="l00531"></a>00531             settings.setValue(QString(<span class="stringliteral">"mp_"</span>) + it-&gt;first.c_str(), i);
<a name="l00532"></a>00532             <span class="keywordflow">if</span> (it-&gt;first == <span class="stringliteral">"debug"</span>) debug = i;
<a name="l00533"></a>00533             <span class="keywordflow">break</span>;
<a name="l00534"></a>00534         }
<a name="l00535"></a>00535         <span class="keywordflow">default</span>: <span class="keywordflow">break</span>;
<a name="l00536"></a>00536         }
<a name="l00537"></a>00537     }
<a name="l00538"></a>00538     mut.unlock();
<a name="l00539"></a>00539 }
<a name="l00540"></a>00540 
<a name="l00541"></a>00541 
<a name="l00542"></a><a class="code" href="classEmulApp.html#5f3359b37dfa26482034792386e65aac">00542</a> <span class="keywordtype">void</span> <a class="code" href="classEmulApp.html#5f3359b37dfa26482034792386e65aac" title="Display a message to the status bar.">EmulApp::statusMsg</a>(<span class="keyword">const</span> QString &amp;msg, <span class="keywordtype">int</span> timeout)
<a name="l00543"></a>00543 {
<a name="l00544"></a>00544     qApp-&gt;postEvent(mainwin, <span class="keyword">new</span> StatusMsgEvent(msg, timeout));
<a name="l00545"></a>00545 }
<a name="l00546"></a>00546 
<a name="l00547"></a><a class="code" href="classEmulApp.html#acbfa1b7996f66c9949c0662db0065c6">00547</a> <span class="keywordtype">void</span> <a class="code" href="classEmulApp.html#acbfa1b7996f66c9949c0662db0065c6" title="Called from a timer every ~250 ms to update the status bar at the bottom of the console...">EmulApp::updateStatusBar</a>()
<a name="l00548"></a>00548 {
<a name="l00549"></a>00549 }
<a name="l00550"></a>00550 
<a name="l00561"></a><a class="code" href="structReentrancyPreventer.html">00561</a> <span class="keyword">struct </span><a class="code" href="structReentrancyPreventer.html" title="A helper class that helps prevent reentrancy into certain functions.">ReentrancyPreventer</a>
<a name="l00562"></a>00562 {
<a name="l00563"></a>00563     <span class="keyword">static</span> <span class="keyword">volatile</span> <span class="keywordtype">int</span> ct;
<a name="l00566"></a><a class="code" href="structReentrancyPreventer.html#7f5d7b40387ab9edf6575602b2121310">00566</a>     <a class="code" href="structReentrancyPreventer.html" title="A helper class that helps prevent reentrancy into certain functions.">ReentrancyPreventer</a>() { ++ct; }
<a name="l00569"></a><a class="code" href="structReentrancyPreventer.html#83ee912ed2df8e2d8ff6d8bd656b79a9">00569</a>     ~<a class="code" href="structReentrancyPreventer.html" title="A helper class that helps prevent reentrancy into certain functions.">ReentrancyPreventer</a>() {--ct; }
<a name="l00571"></a><a class="code" href="structReentrancyPreventer.html#2f9b7344c32f4096b5f73211fb5d3938">00571</a>     operator bool()<span class="keyword"> const </span>{ <span class="keywordflow">return</span> ct == 1; }
<a name="l00572"></a>00572 };
<a name="l00573"></a>00573 <span class="keyword">volatile</span> <span class="keywordtype">int</span> ReentrancyPreventer::ct = 0;
<a name="l00574"></a>00574 
<a name="l00575"></a>00575 
<a name="l00576"></a>00576 <span class="keywordtype">void</span> EmulApp::about()
<a name="l00577"></a>00577 {
<a name="l00578"></a>00578     QMessageBox::about(mainwin, <span class="stringliteral">"About FSM Emulator"</span>, 
<a name="l00579"></a>00579                        <span class="stringliteral">"FSM Emulator v."</span> VersionSTR 
<a name="l00580"></a>00580                        <span class="stringliteral">"\n\n(C) 2008 Calin A. Culianu &lt;cculianu@yahoo.com&gt;\n\n"</span>
<a name="l00581"></a>00581                        <span class="stringliteral">"Developed for the Carlos Brody Lab at\n"</span>
<a name="l00582"></a>00582                        <span class="stringliteral">"Princeton University, Princeton, NJ\n\n"</span>
<a name="l00583"></a>00583                        <span class="stringliteral">"Software License: GPL v2 or later"</span>);
<a name="l00584"></a>00584 }
<a name="l00585"></a>00585 
<a name="l00586"></a>00586 
<a name="l00587"></a>00587 <span class="keywordtype">void</span> EmulApp::setupAppIcon()
<a name="l00588"></a>00588 {
<a name="l00589"></a>00589 <span class="preprocessor">#include "FSM.xpm"</span>    
<a name="l00590"></a>00590 <span class="preprocessor">#include "FSM_smaller.xpm"</span>    
<a name="l00591"></a>00591 <span class="preprocessor">#include "FSM_med.xpm"</span>
<a name="l00592"></a>00592     QPixmap lg(FSM_xpm), sm(FSM_smaller_xpm), med(FSM_med_xpm);
<a name="l00593"></a>00593     QIcon ic(med);
<a name="l00594"></a>00594 
<a name="l00595"></a>00595     ic.addPixmap(lg);
<a name="l00596"></a>00596     ic.addPixmap(sm);
<a name="l00597"></a>00597     
<a name="l00598"></a>00598     mainwin-&gt;setWindowIcon(ic);    
<a name="l00599"></a>00599     controlwin-&gt;setWindowIcon(ic);
<a name="l00600"></a>00600     pfv-&gt;setWindowIcon(ic);
<a name="l00601"></a>00601     mpv-&gt;setWindowIcon(ic);
<a name="l00602"></a>00602 }
<a name="l00603"></a>00603 
<a name="l00604"></a>00604 <span class="keyword">struct </span>EmulApp::FSMPrintFunctor : <span class="keyword">public</span> Emul::PrintFunctor
<a name="l00605"></a>00605 {
<a name="l00606"></a>00606     <span class="keywordtype">void</span> operator()(<span class="keyword">const</span> <span class="keywordtype">char</span> *line) {
<a name="l00607"></a>00607         <a class="code" href="classLog.html" title="Super class of Debug, Warning, Error classes.">Log</a>() &lt;&lt; line;        
<a name="l00608"></a>00608     }
<a name="l00609"></a>00609 };
<a name="l00610"></a>00610 
<a name="l00611"></a>00611 <span class="keywordtype">void</span> EmulApp::startFSM()
<a name="l00612"></a>00612 {
<a name="l00613"></a>00613     <span class="keywordflow">if</span> (!fsmPrintFunctor)  {
<a name="l00614"></a>00614         fsmPrintFunctor = <span class="keyword">new</span> FSMPrintFunctor;
<a name="l00615"></a>00615     }
<a name="l00616"></a>00616     Emul::setPrintFunctor(fsmPrintFunctor);
<a name="l00617"></a>00617 
<a name="l00618"></a>00618     stopFSM();
<a name="l00619"></a>00619     fsm_init_module_parms();
<a name="l00620"></a>00620     loadSettings(); <span class="comment">// makes sure that we re-apply module params from settings to FSM</span>
<a name="l00621"></a>00621 
<a name="l00622"></a>00622     <a class="code" href="classLog.html" title="Super class of Debug, Warning, Error classes.">Log</a>() &lt;&lt; <span class="stringliteral">"Starting FSM...\n"</span>;    
<a name="l00623"></a>00623 
<a name="l00624"></a>00624     <span class="keywordtype">int</span> ret = fsm_entry_func();
<a name="l00625"></a>00625     <span class="keywordflow">if</span> (ret) {
<a name="l00626"></a>00626         stopFSM();
<a name="l00627"></a>00627         std::ostringstream os;
<a name="l00628"></a>00628         os &lt;&lt; <span class="stringliteral">"Could not start FSM, retval was: "</span> &lt;&lt; ret;
<a name="l00629"></a>00629         <span class="keywordflow">throw</span> Exception(os.str());
<a name="l00630"></a>00630     }
<a name="l00631"></a>00631     <span class="keywordflow">else</span>  fsmRunning = <span class="keyword">true</span>;
<a name="l00632"></a>00632 }
<a name="l00633"></a>00633 
<a name="l00634"></a>00634 <span class="keywordtype">void</span> EmulApp::stopFSM()
<a name="l00635"></a>00635 {
<a name="l00636"></a>00636     <span class="keywordflow">if</span> (fsmRunning) {
<a name="l00637"></a>00637         setLatchTimeNanos(0);        
<a name="l00638"></a>00638         fsm_exit_func();
<a name="l00639"></a>00639         fsmRunning = <span class="keyword">false</span>;
<a name="l00640"></a>00640     }
<a name="l00641"></a>00641 }
<a name="l00642"></a>00642 
<a name="l00643"></a>00643 <span class="keywordtype">void</span> EmulApp::restartFSMAndServer()
<a name="l00644"></a>00644 {
<a name="l00645"></a>00645     <span class="keywordflow">try</span> {
<a name="l00646"></a>00646         stopFSMServer();
<a name="l00647"></a>00647         stopSoundServer();
<a name="l00648"></a>00648         stopFSM();
<a name="l00649"></a>00649         startFSM();
<a name="l00650"></a>00650         startFSMServer();
<a name="l00651"></a>00651         startSoundServer();
<a name="l00652"></a>00652     } <span class="keywordflow">catch</span> (<span class="keyword">const</span> Exception &amp; e) {
<a name="l00653"></a>00653         <a class="code" href="classError.html" title="Stream-like class to print an error message to the app&amp;#39;s console window Example:...">Error</a>() &lt;&lt; e.what() &lt;&lt; <span class="stringliteral">"\n"</span>;
<a name="l00654"></a>00654         QMessageBox::critical(0, <span class="stringliteral">"FSM Emulator - Exception Caught"</span>, e.what());
<a name="l00655"></a>00655         quit();        
<a name="l00656"></a>00656     }
<a name="l00657"></a>00657 }
<a name="l00658"></a>00658 
<a name="l00659"></a><a class="code" href="classEmulApp.html#5c06a2370d22a9270285cb42b860f01d">00659</a> <span class="keywordtype">void</span> <a class="code" href="classEmulApp.html#5c06a2370d22a9270285cb42b860f01d" title="reads all stdout from fsm server and posts it to the log">EmulApp::fsmServerHasOutput</a>()
<a name="l00660"></a>00660 {
<a name="l00661"></a>00661     <span class="keywordflow">if</span> (!fsmServerProc) <span class="keywordflow">return</span>;
<a name="l00662"></a>00662     QString str = fsmServerProc-&gt;readAllStandardOutput();
<a name="l00663"></a>00663     QStringList lines = str.split(QRegExp(<span class="stringliteral">"[\n\r]"</span>));
<a name="l00664"></a>00664     <span class="keywordflow">for</span> (QStringList::iterator it = lines.begin(); it != lines.end(); ++it) {
<a name="l00665"></a>00665         str = *it;
<a name="l00666"></a>00666         <span class="keywordflow">while</span> (str.endsWith(<span class="charliteral">'\n'</span>) || str.endsWith(<span class="charliteral">'\r'</span>)) str = str.left(str.length()-1);
<a name="l00667"></a>00667         <span class="keywordflow">if</span> (str.length()) <span class="comment">// suppress empties?</span>
<a name="l00668"></a>00668             <a class="code" href="classEmulApp.html#eed117d40c6220478c7a58d96a93a2f7" title="Thread-safe logging -- logs a line to the log window in a thread-safe manner.">logLine</a>(QString(<span class="stringliteral">"[FSMServer] "</span>) + str, QColor(0x99, 0x00, 0x99));
<a name="l00669"></a>00669     }
<a name="l00670"></a>00670 }
<a name="l00671"></a>00671 
<a name="l00672"></a><a class="code" href="classEmulApp.html#55a4c7df83e3552e074e0dca299ff604">00672</a> <span class="keywordtype">void</span> <a class="code" href="classEmulApp.html#55a4c7df83e3552e074e0dca299ff604" title="reads all stdout from sound server and posts it to the log">EmulApp::soundServerHasOutput</a>()
<a name="l00673"></a>00673 {
<a name="l00674"></a>00674     <span class="keywordflow">if</span> (!soundServerProc) <span class="keywordflow">return</span>;
<a name="l00675"></a>00675     QString str = soundServerProc-&gt;readAllStandardOutput();
<a name="l00676"></a>00676     QStringList lines = str.split(QRegExp(<span class="stringliteral">"[\n\r]"</span>));
<a name="l00677"></a>00677     <span class="keywordflow">for</span> (QStringList::iterator it = lines.begin(); it != lines.end(); ++it) {
<a name="l00678"></a>00678         str = *it;
<a name="l00679"></a>00679         <span class="keywordflow">while</span> (str.endsWith(<span class="charliteral">'\n'</span>) || str.endsWith(<span class="charliteral">'\r'</span>)) str = str.left(str.length()-1);
<a name="l00680"></a>00680         <span class="keywordflow">if</span> (str.length()) <span class="comment">// suppress empties?</span>
<a name="l00681"></a>00681             <a class="code" href="classEmulApp.html#eed117d40c6220478c7a58d96a93a2f7" title="Thread-safe logging -- logs a line to the log window in a thread-safe manner.">logLine</a>(QString(<span class="stringliteral">"[SoundServer] "</span>) + str, QColor(0xcc, 0x33, 0x66));
<a name="l00682"></a>00682     }
<a name="l00683"></a>00683 }
<a name="l00684"></a>00684 
<a name="l00685"></a>00685 <span class="keywordtype">void</span> EmulApp::startFSMServer()
<a name="l00686"></a>00686 {
<a name="l00687"></a>00687     <span class="keywordflow">if</span> (fsmServerProc) <span class="keyword">delete</span> fsmServerProc;
<a name="l00688"></a>00688     fsmServerProc = <span class="keyword">new</span> QProcess(<span class="keyword">this</span>);
<a name="l00689"></a>00689     fsmServerProc-&gt;setProcessChannelMode(QProcess::MergedChannels);        
<a name="l00690"></a>00690     connect(fsmServerProc, SIGNAL(readyRead()), <span class="keyword">this</span>, SLOT(<a class="code" href="classEmulApp.html#5c06a2370d22a9270285cb42b860f01d" title="reads all stdout from fsm server and posts it to the log">fsmServerHasOutput</a>()));
<a name="l00691"></a>00691     connect(fsmServerProc, SIGNAL(error(QProcess::ProcessError)), <span class="keyword">this</span>, SLOT(processError(QProcess::ProcessError)));
<a name="l00692"></a>00692     connect(fsmServerProc, SIGNAL(finished(<span class="keywordtype">int</span>, QProcess::ExitStatus)), <span class="keyword">this</span>, SLOT(processDied()));
<a name="l00693"></a>00693     
<a name="l00694"></a>00694     QStringList args;
<a name="l00695"></a>00695     <span class="keywordflow">if</span> (<a class="code" href="classEmulApp.html#0b6be73c5b64502d0589f8cac2d252cb" title="Returns true iff the application&amp;#39;s console window has debug output printing enabled...">isDebugMode</a>()) args.push_back(<span class="stringliteral">"-d"</span>);
<a name="l00696"></a>00696 <span class="preprocessor">#ifdef Q_OS_WIN</span>
<a name="l00697"></a>00697 <span class="preprocessor"></span>    fsmServerProc-&gt;start(<span class="stringliteral">"FSMServer.exe"</span>, args, QIODevice::ReadOnly);
<a name="l00698"></a>00698 <span class="preprocessor">#elif defined(Q_OS_DARWIN)</span>
<a name="l00699"></a>00699 <span class="preprocessor"></span>    <span class="keywordflow">if</span> (QFile::exists(<span class="stringliteral">"FSMEmulator.app/Contents/MacOS/FSMServer"</span>))
<a name="l00700"></a>00700         fsmServerProc-&gt;start(<span class="stringliteral">"FSMEmulator.app/Contents/MacOS/FSMServer"</span>, args, QIODevice::ReadOnly);
<a name="l00701"></a>00701     <span class="keywordflow">else</span>
<a name="l00702"></a>00702         fsmServerProc-&gt;start(<span class="stringliteral">"./FSMServer"</span>, args, QIODevice::ReadOnly);
<a name="l00703"></a>00703 <span class="preprocessor">#else </span><span class="comment">/* LINUX */</span>
<a name="l00704"></a>00704     fsmServerProc-&gt;start(<span class="stringliteral">"./FSMServer"</span>, args, QIODevice::ReadOnly);
<a name="l00705"></a>00705 <span class="preprocessor">#endif</span>
<a name="l00706"></a>00706 <span class="preprocessor"></span>    <a class="code" href="classLog.html" title="Super class of Debug, Warning, Error classes.">Log</a>() &lt;&lt; <span class="stringliteral">"Starting FSMServer...\n"</span>;    
<a name="l00707"></a>00707     fsmServerProc-&gt;waitForStarted(10000);
<a name="l00708"></a>00708     <span class="keywordflow">if</span> (fsmServerProc-&gt;state() == QProcess::Running) {
<a name="l00709"></a>00709 <span class="preprocessor">#ifdef Q_OS_WIN</span>
<a name="l00710"></a>00710 <span class="preprocessor"></span>        <span class="keywordtype">int</span> pid = fsmServerProc-&gt;pid()-&gt;dwProcessId;
<a name="l00711"></a>00711 <span class="preprocessor">#else</span>
<a name="l00712"></a>00712 <span class="preprocessor"></span>        <span class="keywordtype">int</span> pid = fsmServerProc-&gt;pid();
<a name="l00713"></a>00713 <span class="preprocessor">#endif</span>
<a name="l00714"></a>00714 <span class="preprocessor"></span>        <a class="code" href="classLog.html" title="Super class of Debug, Warning, Error classes.">Log</a>() &lt;&lt; <span class="stringliteral">"Started FSMServer with PID "</span> &lt;&lt; pid &lt;&lt; <span class="stringliteral">"\n"</span>;
<a name="l00715"></a>00715     } <span class="keywordflow">else</span> {
<a name="l00716"></a>00716         QString errStr;
<a name="l00717"></a>00717 
<a name="l00718"></a>00718         <span class="keywordflow">switch</span> (fsmServerProc-&gt;error()) {
<a name="l00719"></a>00719         <span class="keywordflow">case</span> QProcess::FailedToStart: errStr = <span class="stringliteral">"Process failed to start"</span>; <span class="keywordflow">break</span>;
<a name="l00720"></a>00720         <span class="keywordflow">case</span> QProcess::Crashed: errStr = <span class="stringliteral">"Process crashed after starting"</span>; <span class="keywordflow">break</span>;
<a name="l00721"></a>00721         <span class="keywordflow">case</span> QProcess::Timedout: errStr = <span class="stringliteral">"Waiting for the process timed out"</span>; <span class="keywordflow">break</span>;
<a name="l00722"></a>00722         <span class="keywordflow">default</span>: errStr = <span class="stringliteral">"Unknown error"</span>;
<a name="l00723"></a>00723         }
<a name="l00724"></a>00724         <span class="keywordflow">throw</span> Exception(<span class="stringliteral">"Could not start FSMServer: "</span> + errStr);
<a name="l00725"></a>00725     }
<a name="l00726"></a>00726     
<a name="l00727"></a>00727 }
<a name="l00728"></a>00728 
<a name="l00729"></a>00729 <span class="keywordtype">void</span> EmulApp::stopFSMServer()
<a name="l00730"></a>00730 {    
<a name="l00731"></a>00731     <span class="keywordflow">if</span> (!fsmServerProc) <span class="keywordflow">return</span>;
<a name="l00732"></a>00732     fsmServerProc-&gt;blockSignals(<span class="keyword">true</span>);
<a name="l00733"></a>00733     <span class="keywordflow">if</span> (fsmServerProc &amp;&amp; fsmServerProc-&gt;state() == QProcess::Running) {
<a name="l00734"></a>00734 <span class="preprocessor">#ifdef Q_OS_WIN</span>
<a name="l00735"></a>00735 <span class="preprocessor"></span>        <span class="keywordtype">int</span> pid = fsmServerProc-&gt;pid()-&gt;dwProcessId;
<a name="l00736"></a>00736 <span class="preprocessor">#else</span>
<a name="l00737"></a>00737 <span class="preprocessor"></span>        <span class="keywordtype">int</span> pid = fsmServerProc-&gt;pid();
<a name="l00738"></a>00738 <span class="preprocessor">#endif</span>
<a name="l00739"></a>00739 <span class="preprocessor"></span>        fsmServerProc-&gt;terminate();
<a name="l00740"></a>00740         fsmServerProc-&gt;waitForFinished(1000);
<a name="l00741"></a>00741         fsmServerProc-&gt;kill();
<a name="l00742"></a>00742         <a class="code" href="classLog.html" title="Super class of Debug, Warning, Error classes.">Log</a>() &lt;&lt; <span class="stringliteral">"FSMServer process "</span> &lt;&lt; pid &lt;&lt; <span class="stringliteral">" killed."</span>;
<a name="l00743"></a>00743     }
<a name="l00744"></a>00744     <span class="keywordflow">if</span> (fsmServerProc) <span class="keyword">delete</span> fsmServerProc, fsmServerProc = 0;
<a name="l00745"></a>00745 }
<a name="l00746"></a>00746 
<a name="l00747"></a>00747 <span class="keywordtype">void</span> EmulApp::startSoundServer()
<a name="l00748"></a>00748 {
<a name="l00749"></a>00749     <span class="keywordflow">if</span> (sndThr) <span class="keyword">delete</span> sndThr, sndThr = 0;
<a name="l00750"></a>00750     sndThr = <span class="keyword">new</span> SndThr(<span class="keyword">this</span>);
<a name="l00751"></a>00751     sndThr-&gt;start();
<a name="l00752"></a>00752 
<a name="l00753"></a>00753     <span class="keywordflow">if</span> (soundServerProc) <span class="keyword">delete</span> soundServerProc;
<a name="l00754"></a>00754     soundServerProc = <span class="keyword">new</span> QProcess(<span class="keyword">this</span>);
<a name="l00755"></a>00755 
<a name="l00756"></a>00756     soundServerProc-&gt;setProcessChannelMode(QProcess::MergedChannels);
<a name="l00757"></a>00757     connect(soundServerProc, SIGNAL(readyRead()), <span class="keyword">this</span>, SLOT(<a class="code" href="classEmulApp.html#55a4c7df83e3552e074e0dca299ff604" title="reads all stdout from sound server and posts it to the log">soundServerHasOutput</a>()));
<a name="l00758"></a>00758     connect(soundServerProc, SIGNAL(error(QProcess::ProcessError)), <span class="keyword">this</span>, SLOT(processError(QProcess::ProcessError)));
<a name="l00759"></a>00759     connect(soundServerProc, SIGNAL(finished(<span class="keywordtype">int</span>, QProcess::ExitStatus)), <span class="keyword">this</span>, SLOT(processDied()));
<a name="l00760"></a>00760 
<a name="l00761"></a>00761 
<a name="l00762"></a>00762     QStringList args;
<a name="l00763"></a>00763 <span class="preprocessor">#ifdef Q_OS_WIN</span>
<a name="l00764"></a>00764 <span class="preprocessor"></span>    soundServerProc-&gt;start(<span class="stringliteral">"SoundServer.exe"</span>, args, QIODevice::ReadOnly);
<a name="l00765"></a>00765 <span class="preprocessor">#elif defined(Q_OS_DARWIN)</span>
<a name="l00766"></a>00766 <span class="preprocessor"></span>    <span class="keywordflow">if</span> (QFile::exists(<span class="stringliteral">"FSMEmulator.app/Contents/MacOS/SoundServer"</span>))
<a name="l00767"></a>00767         soundServerProc-&gt;start(<span class="stringliteral">"FSMEmulator.app/Contents/MacOS/SoundServer"</span>, args, QIODevice::ReadOnly);
<a name="l00768"></a>00768     <span class="keywordflow">else</span>
<a name="l00769"></a>00769         soundServerProc-&gt;start(<span class="stringliteral">"./SoundServer"</span>, args, QIODevice::ReadOnly);
<a name="l00770"></a>00770 <span class="preprocessor">#else </span><span class="comment">/* LINUX */</span>
<a name="l00771"></a>00771     soundServerProc-&gt;start(<span class="stringliteral">"./SoundServer"</span>, args, QIODevice::ReadOnly);
<a name="l00772"></a>00772 <span class="preprocessor">#endif</span>
<a name="l00773"></a>00773 <span class="preprocessor"></span>    <a class="code" href="classLog.html" title="Super class of Debug, Warning, Error classes.">Log</a>() &lt;&lt; <span class="stringliteral">"Starting SoundServer...\n"</span>;    
<a name="l00774"></a>00774     soundServerProc-&gt;waitForStarted(10000);
<a name="l00775"></a>00775     <span class="keywordflow">if</span> (soundServerProc-&gt;state() == QProcess::Running) {
<a name="l00776"></a>00776 <span class="preprocessor">#ifdef Q_OS_WIN</span>
<a name="l00777"></a>00777 <span class="preprocessor"></span>        <span class="keywordtype">int</span> pid = soundServerProc-&gt;pid()-&gt;dwProcessId;
<a name="l00778"></a>00778 <span class="preprocessor">#else</span>
<a name="l00779"></a>00779 <span class="preprocessor"></span>        <span class="keywordtype">int</span> pid = soundServerProc-&gt;pid();
<a name="l00780"></a>00780 <span class="preprocessor">#endif</span>
<a name="l00781"></a>00781 <span class="preprocessor"></span>        <a class="code" href="classLog.html" title="Super class of Debug, Warning, Error classes.">Log</a>() &lt;&lt; <span class="stringliteral">"Started SoundServer with PID "</span> &lt;&lt; pid &lt;&lt; <span class="stringliteral">"\n"</span>;
<a name="l00782"></a>00782     } <span class="keywordflow">else</span> {
<a name="l00783"></a>00783         QString errStr;
<a name="l00784"></a>00784 
<a name="l00785"></a>00785         <span class="keywordflow">switch</span> (soundServerProc-&gt;error()) {
<a name="l00786"></a>00786         <span class="keywordflow">case</span> QProcess::FailedToStart: errStr = <span class="stringliteral">"Process failed to start"</span>; <span class="keywordflow">break</span>;
<a name="l00787"></a>00787         <span class="keywordflow">case</span> QProcess::Crashed: errStr = <span class="stringliteral">"Process crashed after starting"</span>; <span class="keywordflow">break</span>;
<a name="l00788"></a>00788         <span class="keywordflow">case</span> QProcess::Timedout: errStr = <span class="stringliteral">"Waiting for the process timed out"</span>; <span class="keywordflow">break</span>;
<a name="l00789"></a>00789         <span class="keywordflow">default</span>: errStr = <span class="stringliteral">"Unknown error"</span>;
<a name="l00790"></a>00790         }
<a name="l00791"></a>00791         <span class="keywordflow">throw</span> Exception(<span class="stringliteral">"Could not start SoundServer: "</span> + errStr);
<a name="l00792"></a>00792     }
<a name="l00793"></a>00793     
<a name="l00794"></a>00794 }
<a name="l00795"></a>00795 
<a name="l00796"></a>00796 <span class="keywordtype">void</span> EmulApp::destroyAllSounds()
<a name="l00797"></a>00797 {
<a name="l00798"></a>00798     SoundPlayerMap::iterator it;
<a name="l00799"></a>00799     <span class="keywordflow">for</span> (it = soundPlayerMap.begin(); it != soundPlayerMap.end(); ++it) {
<a name="l00800"></a>00800         it-&gt;second-&gt;stop();
<a name="l00801"></a>00801         <span class="keyword">delete</span> it-&gt;second;
<a name="l00802"></a>00802     }
<a name="l00803"></a>00803     soundPlayerMap.clear();
<a name="l00804"></a>00804 }
<a name="l00805"></a>00805 
<a name="l00806"></a>00806 <span class="keywordtype">void</span> EmulApp::stopSoundServer()
<a name="l00807"></a>00807 {
<a name="l00808"></a>00808     destroyAllSounds();
<a name="l00809"></a>00809     controlwin-&gt;resetAllSoundStats();
<a name="l00810"></a>00810     <span class="keywordflow">if</span> (!soundServerProc) <span class="keywordflow">return</span>;
<a name="l00811"></a>00811     soundServerProc-&gt;blockSignals(<span class="keyword">true</span>);
<a name="l00812"></a>00812 
<a name="l00813"></a>00813     <span class="keywordflow">if</span> (soundServerProc-&gt;state() == QProcess::Running) {
<a name="l00814"></a>00814 <span class="preprocessor">#ifdef Q_OS_WIN</span>
<a name="l00815"></a>00815 <span class="preprocessor"></span>        <span class="keywordtype">int</span> pid = soundServerProc-&gt;pid()-&gt;dwProcessId;
<a name="l00816"></a>00816 <span class="preprocessor">#else</span>
<a name="l00817"></a>00817 <span class="preprocessor"></span>        <span class="keywordtype">int</span> pid = soundServerProc-&gt;pid();
<a name="l00818"></a>00818 <span class="preprocessor">#endif</span>
<a name="l00819"></a>00819 <span class="preprocessor"></span>        soundServerProc-&gt;terminate();
<a name="l00820"></a>00820         soundServerProc-&gt;waitForFinished(1000);
<a name="l00821"></a>00821         soundServerProc-&gt;kill();
<a name="l00822"></a>00822         <a class="code" href="classLog.html" title="Super class of Debug, Warning, Error classes.">Log</a>() &lt;&lt; <span class="stringliteral">"SoundServer process "</span> &lt;&lt; pid &lt;&lt; <span class="stringliteral">" killed."</span>;
<a name="l00823"></a>00823     }
<a name="l00824"></a>00824     <span class="keywordflow">if</span> (soundServerProc) <span class="keyword">delete</span> soundServerProc, soundServerProc = 0;
<a name="l00825"></a>00825     <span class="keywordflow">if</span> (sndThr) <span class="keyword">delete</span> sndThr, sndThr = 0;
<a name="l00826"></a>00826 }
<a name="l00827"></a>00827 
<a name="l00828"></a>00828 <span class="keywordtype">void</span> EmulApp::showProcFileViewer()
<a name="l00829"></a>00829 {
<a name="l00830"></a>00830     pfv-&gt;show();
<a name="l00831"></a>00831     pfv-&gt;activateWindow();
<a name="l00832"></a>00832     pfv-&gt;raise();
<a name="l00833"></a>00833 }
<a name="l00834"></a>00834 
<a name="l00835"></a>00835 <span class="keywordtype">void</span> EmulApp::showModParmsViewer()
<a name="l00836"></a>00836 {
<a name="l00837"></a>00837     <span class="keyword">const</span> Emul::ModuleParmMap &amp; m = Emul::getModuleParms();
<a name="l00838"></a>00838     <span class="keywordflow">if</span> (mpv-&gt;isHidden()) mp-&gt;setModuleParms(&amp;m);
<a name="l00839"></a>00839     mpv-&gt;show();
<a name="l00840"></a>00840     mpv-&gt;activateWindow();
<a name="l00841"></a>00841     mpv-&gt;raise();
<a name="l00842"></a>00842 }
<a name="l00843"></a>00843 
<a name="l00844"></a>00844 <span class="keywordtype">void</span> EmulApp::showControlWin()
<a name="l00845"></a>00845 {
<a name="l00846"></a>00846     controlwin-&gt;show();
<a name="l00847"></a>00847     controlwin-&gt;activateWindow();
<a name="l00848"></a>00848     controlwin-&gt;raise();
<a name="l00849"></a>00849 }
<a name="l00850"></a>00850 
<a name="l00852"></a><a class="code" href="classEmulApp.html#8a16420a03370c1d4787d92debcfbd4d">00852</a> <span class="keywordtype">void</span> <a class="code" href="classEmulApp.html#8a16420a03370c1d4787d92debcfbd4d" title="connected to applyParamsBut clicked(), applies params, restarts fsm">EmulApp::applyModParams</a>()
<a name="l00853"></a>00853 {
<a name="l00854"></a>00854 
<a name="l00855"></a>00855     stopFSM();
<a name="l00856"></a>00856     mp-&gt;applyChanges();
<a name="l00857"></a>00857     saveSettings();
<a name="l00858"></a>00858     applyParamsBut-&gt;setEnabled(<span class="keyword">false</span>);
<a name="l00859"></a>00859     revertParamsBut-&gt;setEnabled(<span class="keyword">false</span>);    
<a name="l00860"></a>00860     restartFSMAndServer();
<a name="l00861"></a>00861 }
<a name="l00862"></a>00862 
<a name="l00863"></a>00863 
<a name="l00865"></a><a class="code" href="classEmulApp.html#f592f84e4877b72aa35c725bcf5ce729">00865</a> <span class="keywordtype">void</span> <a class="code" href="classEmulApp.html#f592f84e4877b72aa35c725bcf5ce729" title="connected to revertParamsBut clicked(), reverts params, disables buttons">EmulApp::revertModParams</a>()
<a name="l00866"></a>00866 {
<a name="l00867"></a>00867     mp-&gt;revertChanges();
<a name="l00868"></a>00868     applyParamsBut-&gt;setEnabled(<span class="keyword">false</span>);
<a name="l00869"></a>00869     revertParamsBut-&gt;setEnabled(<span class="keyword">false</span>);    
<a name="l00870"></a>00870 }
<a name="l00871"></a>00871 
<a name="l00873"></a><a class="code" href="classEmulApp.html#952fdfa8fdfe3474164aa305334159a2">00873</a> <span class="keywordtype">void</span> <a class="code" href="classEmulApp.html#952fdfa8fdfe3474164aa305334159a2" title="enables the applyParamsBut">EmulApp::modParamsChanged</a>()
<a name="l00874"></a>00874 {
<a name="l00875"></a>00875     applyParamsBut-&gt;setEnabled(<span class="keyword">true</span>);
<a name="l00876"></a>00876     revertParamsBut-&gt;setEnabled(<span class="keyword">true</span>);
<a name="l00877"></a>00877 }
<a name="l00878"></a>00878 
<a name="l00879"></a>00879 
<a name="l00880"></a>00880 <span class="keywordtype">void</span> EmulApp::gotSound(<span class="keywordtype">unsigned</span> <span class="keywordtype">id</span>, <span class="keyword">const</span> QString &amp; fname, <span class="keywordtype">bool</span> loop_flg)
<a name="l00881"></a>00881 {
<a name="l00882"></a>00882     <a class="code" href="classDebug.html" title="Stream-like class to print a debug message to the app&amp;#39;s console window Example:...">Debug</a>() &lt;&lt; <span class="stringliteral">"Got new sound "</span> &lt;&lt; <span class="keywordtype">id</span> &lt;&lt; <span class="stringliteral">" for filename `"</span> &lt;&lt; fname &lt;&lt; <span class="stringliteral">"'"</span>;
<a name="l00883"></a>00883     SoundPlayerMap::iterator it = soundPlayerMap.find(<span class="keywordtype">id</span>);
<a name="l00884"></a>00884     <a class="code" href="classSoundPlayer.html">SoundPlayer</a> *sp = 0;
<a name="l00885"></a>00885     <span class="keywordflow">if</span> (it != soundPlayerMap.end()) {
<a name="l00886"></a>00886         <span class="keyword">delete</span> it-&gt;second;
<a name="l00887"></a>00887         soundPlayerMap.erase(it);
<a name="l00888"></a>00888     }
<a name="l00889"></a>00889     sp = <span class="keyword">new</span> <a class="code" href="classSoundPlayer.html">SoundPlayer</a>(fname, <span class="keyword">this</span>, loop_flg);
<a name="l00890"></a>00890     soundPlayerMap[id] = sp;
<a name="l00891"></a>00891 }
<a name="l00892"></a>00892 
<a name="l00893"></a>00893 <span class="keywordtype">void</span> EmulApp::trigSound(<span class="keywordtype">int</span> sndtrig)
<a name="l00894"></a>00894 {
<a name="l00895"></a>00895     <span class="keyword">const</span> <span class="keywordtype">bool</span> dostop = sndtrig &lt; 0;    
<a name="l00896"></a>00896     <span class="keyword">const</span> <span class="keywordtype">unsigned</span> snd = dostop ? -sndtrig : sndtrig;
<a name="l00897"></a>00897     <a class="code" href="classEmulApp.html#2183269c06198dd73053d1b0bf7d5711" title="read/written by class SndThr and also by EmulApp::trigSound(int)">lastSndEvt</a> = sndtrig;
<a name="l00898"></a>00898 
<a name="l00899"></a>00899     SoundPlayerMap::iterator it = soundPlayerMap.find(snd);
<a name="l00900"></a>00900     <a class="code" href="classSoundPlayer.html">SoundPlayer</a> *sp = 0;
<a name="l00901"></a>00901     <span class="keywordflow">if</span> (it == soundPlayerMap.end()) {
<a name="l00902"></a>00902         <a class="code" href="classError.html" title="Stream-like class to print an error message to the app&amp;#39;s console window Example:...">Error</a>() &lt;&lt; <span class="stringliteral">"Triggered unknown sound "</span> &lt;&lt; snd;
<a name="l00903"></a>00903         <span class="keywordflow">return</span>;
<a name="l00904"></a>00904     }
<a name="l00905"></a>00905     <span class="keywordflow">else</span> sp = it-&gt;second;
<a name="l00906"></a>00906     <a class="code" href="classDebug.html" title="Stream-like class to print a debug message to the app&amp;#39;s console window Example:...">Debug</a>() &lt;&lt; <span class="stringliteral">"Got sound trig "</span> &lt;&lt; sndtrig &lt;&lt; <span class="stringliteral">" for filename `"</span> &lt;&lt; sp-&gt;<a class="code" href="classSoundPlayer.html#09a11aa0c28e1ec749cb55ae1981a161">fileName</a>() &lt;&lt; <span class="stringliteral">"'"</span>;
<a name="l00907"></a>00907     <span class="keywordflow">if</span> (dostop) {
<a name="l00908"></a>00908         <span class="comment">//Debug() &lt;&lt; "sound " &lt;&lt; snd &lt;&lt; " stop";</span>
<a name="l00909"></a>00909         sp-&gt;<a class="code" href="classSoundPlayer.html#11d2fd57fbb9b0b386451733f9cca5f2">stop</a>();
<a name="l00910"></a>00910         controlwin-&gt;untriggeredSound(snd);
<a name="l00911"></a>00911     } <span class="keywordflow">else</span> {
<a name="l00912"></a>00912         <span class="comment">//Debug() &lt;&lt; "sound " &lt;&lt; snd &lt;&lt; " play";</span>
<a name="l00913"></a>00913         sp-&gt;<a class="code" href="classSoundPlayer.html#11d2fd57fbb9b0b386451733f9cca5f2">stop</a>();
<a name="l00914"></a>00914         sp-&gt;<a class="code" href="classSoundPlayer.html#15133f4990b8f8375edd0f0e6a8aa25a">play</a>();
<a name="l00915"></a>00915         controlwin-&gt;triggeredSound(snd);
<a name="l00916"></a>00916     }    
<a name="l00917"></a>00917 }
<a name="l00918"></a>00918 
<a name="l00919"></a>00919 <span class="comment">/*static*/</span> <span class="keywordtype">int</span> EmulApp::soundTrigFunc(<span class="keywordtype">unsigned</span> card, <span class="keywordtype">int</span> trig)
<a name="l00920"></a>00920 {
<a name="l00921"></a>00921     (void)card; <span class="comment">// ignored..</span>
<a name="l00922"></a>00922     <span class="comment">//Debug() &lt;&lt; "EmulApp::soundTrigFunc(" &lt;&lt; card &lt;&lt; ", " &lt;&lt; trig &lt;&lt; ")";</span>
<a name="l00923"></a>00923     QCoreApplication::postEvent(<a class="code" href="classEmulApp.html#4e4ccc974fc75b59e57f07d85224786b" title="Returns a pointer to the singleton instance of this class, if one exists, otherwise...">EmulApp::instance</a>(), <span class="keyword">new</span> SoundTrigEvent(trig));
<a name="l00924"></a>00924     <span class="keywordflow">return</span> 1;
<a name="l00925"></a>00925 }
<a name="l00926"></a>00926 
<a name="l00927"></a>00927 <span class="preprocessor">#if defined(Q_OS_WIN) || defined(Q_OS_CYGWIN)</span>
<a name="l00928"></a>00928 <span class="preprocessor"></span><span class="keyword">static</span>  QString GetLastErrorMessage(DWORD *err_out = 0)
<a name="l00929"></a>00929 {
<a name="l00930"></a>00930     DWORD err = GetLastError();
<a name="l00931"></a>00931     <span class="keywordflow">if</span> (err_out) *err_out = err;
<a name="l00932"></a>00932     <span class="keywordtype">char</span> buf[256];
<a name="l00933"></a>00933     buf[0] = 0;
<a name="l00934"></a>00934     FormatMessageA(FORMAT_MESSAGE_FROM_SYSTEM, 0, err, 0, buf, 256, 0);
<a name="l00935"></a>00935     <span class="keywordflow">return</span> buf;
<a name="l00936"></a>00936 }
<a name="l00937"></a>00937 <span class="keywordtype">void</span> EmulApp::killProcs(QString name)
<a name="l00938"></a>00938 {
<a name="l00939"></a>00939     <span class="keywordflow">if</span> (!name.endsWith(<span class="stringliteral">".exe"</span>, Qt::CaseInsensitive)) name += <span class="stringliteral">".exe"</span>;
<a name="l00940"></a>00940     DWORD pids[8192];
<a name="l00941"></a>00941     DWORD bret = 0;
<a name="l00942"></a>00942     DWORD WINAPI (*fGetProcessImageFileNameA)(HANDLE, <span class="keyword">const</span> <span class="keywordtype">char</span> *, DWORD) = 0;
<a name="l00943"></a>00943     HMODULE psapi_handle = LoadLibraryA(<span class="stringliteral">"psapi.dll"</span>);
<a name="l00944"></a>00944     <span class="comment">// first see if we are on WinXP or Windows Vista by seeing if we can open psapi.dll and then fund the GetProcessImageFileNameA function</span>
<a name="l00945"></a>00945     <span class="comment">// if not, resort to calling the command-line program 'taskkill'</span>
<a name="l00946"></a>00946     <span class="keywordflow">if</span> (psapi_handle) {
<a name="l00947"></a>00947         fGetProcessImageFileNameA = (DWORD WINAPI(*)(HANDLE, <span class="keyword">const</span> <span class="keywordtype">char</span> *, DWORD))GetProcAddress(psapi_handle, <span class="stringliteral">"GetProcessImageFileNameA"</span>);
<a name="l00948"></a>00948     } <span class="keywordflow">else</span> {
<a name="l00949"></a>00949         DWORD err;
<a name="l00950"></a>00950         QString msg = GetLastErrorMessage(&amp;err);
<a name="l00951"></a>00951         <a class="code" href="classWarning.html" title="Stream-like class to print a warning message to the app&amp;#39;s console window.">Warning</a>() &lt;&lt; <span class="stringliteral">"LoadLibrary(\"psapi.dll\") failed, error was: ("</span> &lt;&lt; err &lt;&lt; <span class="stringliteral">") "</span> &lt;&lt; msg;
<a name="l00952"></a>00952     }
<a name="l00953"></a>00953     <span class="keywordflow">if</span> (fGetProcessImageFileNameA) {
<a name="l00954"></a>00954         <a class="code" href="classDebug.html" title="Stream-like class to print a debug message to the app&amp;#39;s console window Example:...">Debug</a>() &lt;&lt; <span class="stringliteral">"Got handle to psapi.dll and found GetProcessImageFileNameA at address "</span> &lt;&lt; ((<span class="keywordtype">void</span> *)fGetProcessImageFileNameA);
<a name="l00955"></a>00955         <span class="keywordtype">int</span> n, i;
<a name="l00956"></a>00956         <span class="keywordflow">if</span> (!EnumProcesses(pids, <span class="keyword">sizeof</span>(pids), &amp;bret)) {
<a name="l00957"></a>00957             <a class="code" href="classError.html" title="Stream-like class to print an error message to the app&amp;#39;s console window Example:...">Error</a>() &lt;&lt; <span class="stringliteral">"Could not enumerate processes for killProcs("</span> &lt;&lt; name &lt;&lt; <span class="stringliteral">")"</span>;
<a name="l00958"></a>00958             <span class="keywordflow">return</span>;
<a name="l00959"></a>00959             }
<a name="l00960"></a>00960         n = bret / <span class="keyword">sizeof</span>(*pids);
<a name="l00961"></a>00961         <span class="keywordflow">for</span> (i = 0; i &lt; n; ++i) {
<a name="l00962"></a>00962             HANDLE h = OpenProcess(PROCESS_ALL_ACCESS, 0, pids[i]);
<a name="l00963"></a>00963             <span class="keywordflow">if</span> (h) {
<a name="l00964"></a>00964                 <span class="keywordtype">char</span> strbuf[1024];
<a name="l00965"></a>00965                 DWORD size = <span class="keyword">sizeof</span> strbuf;
<a name="l00966"></a>00966                 <span class="keywordflow">if</span> (fGetProcessImageFileNameA(h, strbuf, size)) {
<a name="l00967"></a>00967                     strbuf[<span class="keyword">sizeof</span>(strbuf)-1] = 0;
<a name="l00968"></a>00968                     QString exename = strbuf;
<a name="l00969"></a>00969                     QStringList pathcomps = exename.split(<span class="stringliteral">"\\"</span>);
<a name="l00970"></a>00970                     <span class="keywordflow">if</span> (pathcomps.size() &gt; 1) {
<a name="l00971"></a>00971                         exename = pathcomps.back();
<a name="l00972"></a>00972                     }
<a name="l00973"></a>00973                     <a class="code" href="classDebug.html" title="Stream-like class to print a debug message to the app&amp;#39;s console window Example:...">Debug</a>() &lt;&lt; <span class="stringliteral">"Found process "</span> &lt;&lt; pids[i] &lt;&lt; <span class="stringliteral">" named "</span> &lt;&lt; exename;
<a name="l00974"></a>00974                     <span class="keywordflow">if</span> (exename.toLower() == name.toLower()) {
<a name="l00975"></a>00975                         TerminateProcess(h, 0);
<a name="l00976"></a>00976                         <a class="code" href="classLog.html" title="Super class of Debug, Warning, Error classes.">Log</a>() &lt;&lt; <span class="stringliteral">"Killing process "</span> &lt;&lt; pids[i] &lt;&lt; <span class="stringliteral">" named `"</span> &lt;&lt; exename &lt;&lt; <span class="stringliteral">"'"</span>;
<a name="l00977"></a>00977                     }
<a name="l00978"></a>00978                 } <span class="keywordflow">else</span> {
<a name="l00979"></a>00979                     <a class="code" href="classWarning.html" title="Stream-like class to print a warning message to the app&amp;#39;s console window.">Warning</a>() &lt;&lt; <span class="stringliteral">"Could not grab .exe name for PID "</span> &lt;&lt; pids[i];
<a name="l00980"></a>00980                 }
<a name="l00981"></a>00981                 CloseHandle(h);
<a name="l00982"></a>00982             } <span class="keywordflow">else</span> {
<a name="l00983"></a>00983                 <a class="code" href="classDebug.html" title="Stream-like class to print a debug message to the app&amp;#39;s console window Example:...">Debug</a>() &lt;&lt; <span class="stringliteral">"Could not open process with PID "</span> &lt;&lt; pids[i];
<a name="l00984"></a>00984             }
<a name="l00985"></a>00985         }
<a name="l00986"></a>00986         FreeLibrary(psapi_handle);
<a name="l00987"></a>00987         psapi_handle = 0;
<a name="l00988"></a>00988     } <span class="keywordflow">else</span> {
<a name="l00989"></a>00989         <a class="code" href="classWarning.html" title="Stream-like class to print a warning message to the app&amp;#39;s console window.">Warning</a>() &lt;&lt; <span class="stringliteral">"killProcs() failed to use PSAPI for enumerating processes, reverting to taskkill.exe method"</span>;
<a name="l00990"></a>00990         QStringList args;
<a name="l00991"></a>00991         args.push_back(<span class="stringliteral">"/F"</span>);
<a name="l00992"></a>00992         args.push_back(<span class="stringliteral">"/IM"</span>);
<a name="l00993"></a>00993         args.push_back(<span class="stringliteral">"/T"</span>);
<a name="l00994"></a>00994         args.push_back(name);
<a name="l00995"></a>00995         QProcess::execute(<span class="stringliteral">"taskkill"</span>, args);
<a name="l00996"></a>00996     }
<a name="l00997"></a>00997 }
<a name="l00998"></a>00998 <span class="preprocessor">#elif defined(Q_OS_LINUX) || defined(Q_OS_DARWIN) </span><span class="comment">/* Unixey */</span>
<a name="l00999"></a>00999 <span class="keywordtype">void</span> EmulApp::killProcs(QString name)
<a name="l01000"></a>01000 {
<a name="l01001"></a>01001     std::system((QString(<span class="stringliteral">"killall -TERM '"</span>) + name + <span class="stringliteral">"' &gt;/dev/null 2&gt;&amp;1"</span>).toUtf8().constData());
<a name="l01002"></a>01002     usleep(250000);
<a name="l01003"></a>01003     std::system((QString(<span class="stringliteral">"killall -KILL '"</span>) + name + <span class="stringliteral">"' &gt;/dev/null 2&gt;&amp;1"</span>).toUtf8().constData());
<a name="l01004"></a>01004 }
<a name="l01005"></a>01005 <span class="preprocessor">#else</span>
<a name="l01006"></a>01006 <span class="preprocessor"></span><span class="preprocessor">#  error need to implement EmulApp::killProcs() for this platform!</span>
<a name="l01007"></a>01007 <span class="preprocessor"></span><span class="preprocessor">#endif</span>
<a name="l01008"></a>01008 <span class="preprocessor"></span>
<a name="l01009"></a>01009 <span class="keywordtype">void</span> EmulApp::processError(QProcess::ProcessError err)
<a name="l01010"></a>01010 {
<a name="l01011"></a>01011     <span class="keywordflow">if</span> (closingDown()) <span class="keywordflow">return</span>;
<a name="l01012"></a>01012     QString msg, name;
<a name="l01013"></a>01013     <span class="keywordflow">if</span> (sender() == fsmServerProc) name = <span class="stringliteral">"FSMServer"</span>;
<a name="l01014"></a>01014     <span class="keywordflow">else</span> <span class="keywordflow">if</span> (sender() == fsmServerProc) name = <span class="stringliteral">"SoundServer"</span>;
<a name="l01015"></a>01015     <span class="keywordflow">else</span> <span class="keywordflow">return</span>; <span class="comment">// spurious error signal? //name = "(unknown)";</span>
<a name="l01016"></a>01016     <span class="keywordflow">switch</span> (err) {
<a name="l01017"></a>01017     <span class="keywordflow">case</span> QProcess::FailedToStart:
<a name="l01018"></a>01018         msg = QString(<span class="stringliteral">"A required process `"</span>) + name + <span class="stringliteral">"' failed to start."</span>;
<a name="l01019"></a>01019         <span class="keywordflow">break</span>;
<a name="l01020"></a>01020     <span class="keywordflow">case</span> QProcess::Crashed:
<a name="l01021"></a>01021         msg = QString(<span class="stringliteral">"The required process `"</span>) + name + <span class="stringliteral">"' exited unexpectedly."</span>;
<a name="l01022"></a>01022         <span class="keywordflow">break</span>;
<a name="l01023"></a>01023     <span class="keywordflow">case</span> QProcess::Timedout:
<a name="l01024"></a>01024         msg = QString(<span class="stringliteral">"A required process `"</span>) + name + <span class="stringliteral">"' timed out."</span>;
<a name="l01025"></a>01025         <span class="keywordflow">break</span>;
<a name="l01026"></a>01026     <span class="keywordflow">case</span> QProcess::WriteError:
<a name="l01027"></a>01027     <span class="keywordflow">case</span> QProcess::ReadError:
<a name="l01028"></a>01028         msg = QString(<span class="stringliteral">"Read/Write error communicating with process `"</span>) + name + <span class="stringliteral">"'."</span>;
<a name="l01029"></a>01029         <span class="keywordflow">break</span>;
<a name="l01030"></a>01030     <span class="keywordflow">case</span> QProcess::UnknownError:
<a name="l01031"></a>01031     <span class="keywordflow">default</span>:
<a name="l01032"></a>01032         msg = QString(<span class="stringliteral">"An unknown error occurred with the `"</span>) + name + <span class="stringliteral">"' process."</span>;
<a name="l01033"></a>01033         <span class="keywordflow">break</span>;
<a name="l01034"></a>01034     }
<a name="l01035"></a>01035     QMessageBox::critical(mainwin, <span class="stringliteral">"FSM Emulator - Process Error"</span>, msg);
<a name="l01036"></a>01036     postEvent(<span class="keyword">this</span>, <span class="keyword">new</span> QuitEvent);
<a name="l01037"></a>01037 }
<a name="l01038"></a>01038 
<a name="l01039"></a>01039 <span class="keywordtype">void</span> EmulApp::processDied()
<a name="l01040"></a>01040 {    
<a name="l01041"></a>01041     processError(QProcess::Crashed);
<a name="l01042"></a>01042 }
<a name="l01043"></a>01043 
<a name="l01044"></a>01044 
<a name="l01045"></a>01045 <span class="keywordtype">void</span> EmulApp::buildAppMenus()
<a name="l01046"></a>01046 {
<a name="l01047"></a>01047 <span class="preprocessor">#ifdef Q_OS_DARWIN</span>
<a name="l01048"></a>01048 <span class="preprocessor"></span>    QMenuBar *mb = <span class="keyword">new</span> QMenuBar(0); <span class="comment">// on OSX we make the 'default menubar' (a parentless menubar) here.. so that it's app-global</span>
<a name="l01049"></a>01049 <span class="preprocessor">#else</span>
<a name="l01050"></a>01050 <span class="preprocessor"></span>    QMenuBar *mb = mainwin-&gt;menuBar(); <span class="comment">// on other platforms it's just part of the mainwin</span>
<a name="l01051"></a>01051 <span class="preprocessor">#endif</span>
<a name="l01052"></a>01052 <span class="preprocessor"></span>    QMenu *m = mb-&gt;addMenu(<span class="stringliteral">"&amp;File"</span>);
<a name="l01053"></a>01053     m-&gt;addAction(<span class="stringliteral">"&amp;Restart FSM"</span>, <span class="keyword">this</span>, SLOT(restartFSMAndServer()));
<a name="l01054"></a>01054     m-&gt;addSeparator();
<a name="l01055"></a>01055     m-&gt;addAction(<span class="stringliteral">"&amp;Quit"</span>, <span class="keyword">this</span>, SLOT(quit()));
<a name="l01056"></a>01056     m = mb-&gt;addMenu(<span class="stringliteral">"&amp;Window"</span>);
<a name="l01057"></a>01057     m-&gt;addAction(<span class="stringliteral">"&amp;Control Window"</span>, <span class="keyword">this</span>, SLOT(showControlWin()));
<a name="l01058"></a>01058     m-&gt;addSeparator();
<a name="l01059"></a>01059     m-&gt;addAction(<span class="stringliteral">"&amp;ProcFile Viewer Window"</span>, <span class="keyword">this</span>, SLOT(showProcFileViewer()));
<a name="l01060"></a>01060     m-&gt;addAction(<span class="stringliteral">"&amp;ModParms Viewer Window"</span>, <span class="keyword">this</span>, SLOT(showModParmsViewer()));
<a name="l01061"></a>01061 
<a name="l01062"></a>01062     m = mb-&gt;addMenu(<span class="stringliteral">"&amp;Help"</span>);
<a name="l01063"></a>01063     m-&gt;addAction(<span class="stringliteral">"&amp;About"</span>, <span class="keyword">this</span>, SLOT(about()));
<a name="l01064"></a>01064     m-&gt;addAction(<span class="stringliteral">"About &amp;Qt"</span>, <span class="keyword">this</span>, SLOT(aboutQt()));
<a name="l01065"></a>01065 }
</pre></div><hr size="1"><address style="text-align: right;"><small>Generated on Sat Jan 10 10:30:46 2009 for FSMEmulator by&nbsp;
<a href="http://www.doxygen.org/index.html">
<img src="doxygen.png" alt="doxygen" align="middle" border="0"></a> 1.5.4 </small></address>
</body>
</html>
